<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>KVN.OS Shell - Enhanced</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <style>
Â  Â  Â  Â  /* Custom styles for the professional, dark dev theme */
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --primary-bg: #111827; /* Deep Black */
Â  Â  Â  Â  Â  Â  --accent-cyan: #06b6d4; /* Vibrant Cyan for highlights */
Â  Â  Â  Â  Â  Â  --accent-green: #4ade80; /* Neon Green for status */
Â  Â  Â  Â  Â  Â  --text-color: #e5e7eb; /* Off-White for readability */
Â  Â  Â  Â  Â  Â  --card-bg: #1e293b; /* Slate 800 for card background */
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  }

Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  height: 100vh;
Â  Â  Â  Â  Â  Â  width: 100vw;
Â  Â  Â  Â  Â  Â  overflow: hidden;Â 
Â  Â  Â  Â  Â  Â  background-color: var(--primary-bg);
Â  Â  Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* 1. KVN.OS WINDOW STYLES */
Â  Â  Â  Â  .os-window {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  background-color: var(--card-bg);
Â  Â  Â  Â  Â  Â  border: 1px solid #334155;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
Â  Â  Â  Â  Â  Â  border-radius: 0.5rem;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  min-width: 300px;
Â  Â  Â  Â  Â  Â  min-height: 200px;
Â  Â  Â  Â  Â  Â  transition: box-shadow 0.1s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .os-window.focused {
Â  Â  Â  Â  Â  Â  z-index: 50; /* Z-index managed in JS, but a base is needed */
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 0 2px var(--accent-cyan);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .window-title-bar {
Â  Â  Â  Â  Â  Â  cursor: grab;
Â  Â  Â  Â  Â  Â  background-color: #0f172a; /* Darker header */
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #334155;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .window-content {
Â  Â  Â  Â  Â  Â  padding: 1rem;
Â  Â  Â  Â  Â  Â  height: calc(100% - 40px); /* Adjust for title bar height */
Â  Â  Â  Â  Â  Â  overflow: auto;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* 2. METRICS HUB STYLES */
Â  Â  Â  Â  .metric-card {
Â  Â  Â  Â  Â  Â  background-color: #1a2333;Â 
Â  Â  Â  Â  Â  Â  border: 1px solid #334155;
Â  Â  Â  Â  Â  Â  box-shadow: none;Â 
Â  Â  Â  Â  Â  Â  transition: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .metric-value {
Â  Â  Â  Â  Â  Â  color: var(--accent-cyan);
Â  Â  Â  Â  Â  Â  font-family: 'Consolas', 'Monospace', monospace;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  }
Â  Â  Â  Â  .metric-label {
Â  Â  Â  Â  Â  Â  color: #94a3b8;
Â  Â  Â  Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  letter-spacing: 0.05em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .progress-bar {
Â  Â  Â  Â  Â  Â  height: 6px;
Â  Â  Â  Â  Â  Â  background-color: #475569;
Â  Â  Â  Â  Â  Â  border-radius: 9999px;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â  .progress-bar-fill {
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background-color: var(--accent-green);
Â  Â  Â  Â  Â  Â  transition: width 0.3s ease-out;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* 3. LOADING SCREEN STYLES */
Â  Â  Â  Â  .loading-bar-inner {
Â  Â  Â  Â  Â  Â  background-color: var(--accent-cyan);
Â  Â  Â  Â  Â  Â  transition: width 0.18s linear;
Â  Â  Â  Â  }
Â  Â  Â  Â  .loading-screen-text {
Â  Â  Â  Â  Â  Â  font-family: 'Consolas', 'Monospace', monospace;
Â  Â  Â  Â  Â  Â  color: #9ca3af;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* 4. TEXTAREA / CODE STYLES */
Â  Â  Â  Â  textarea.code-input, textarea.code-output {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 0.75rem;
Â  Â  Â  Â  Â  Â  border-radius: 0.375rem;
Â  Â  Â  Â  Â  Â  font-family: 'Consolas', 'Monospace', monospace;
Â  Â  Â  Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  Â  Â  Â  color: var(--accent-green);
Â  Â  Â  Â  Â  Â  background-color: #0f172a;
Â  Â  Â  Â  Â  Â  border: 1px solid #334155;
Â  Â  Â  Â  Â  Â  resize: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* 5. CALCULATOR STYLES */
Â  Â  Â  Â  .calc-display {
Â  Â  Â  Â  Â  Â  background-color: #000;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 1rem;
Â  Â  Â  Â  Â  Â  font-size: 2.5rem;
Â  Â  Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  Â  Â  border-radius: 0.25rem;
Â  Â  Â  Â  Â  Â  overflow-x: auto;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  Â  Â  margin-bottom: 0.5rem;
Â  Â  Â  Â  Â  Â  height: 70px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .calc-button {
Â  Â  Â  Â  Â  Â  background-color: #334155;
Â  Â  Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  Â  Â  padding: 1rem;
Â  Â  Â  Â  Â  Â  font-size: 1.25rem;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  border-radius: 0.5rem;
Â  Â  Â  Â  Â  Â  transition: background-color 0.15s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .calc-button:hover {
Â  Â  Â  Â  Â  Â  background-color: #475569;
Â  Â  Â  Â  }
Â  Â  Â  Â  .calc-op {
Â  Â  Â  Â  Â  Â  background-color: #06b6d4; /* Cyan */
Â  Â  Â  Â  }
Â  Â  Â  Â  .calc-op:hover {
Â  Â  Â  Â  Â  Â  background-color: #0891b2;
Â  Â  Â  Â  }
Â  Â  Â  Â  .calc-eq {
Â  Â  Â  Â  Â  Â  background-color: #4ade80; /* Green */
Â  Â  Â  Â  Â  Â  color: #0f172a;
Â  Â  Â  Â  }
Â  Â  Â  Â  .calc-eq:hover {
Â  Â  Â  Â  Â  Â  background-color: #22c55e;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* 6. TODO LIST STYLES */
Â  Â  Â  Â  .todo-item {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  padding: 0.5rem 0;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #334155;
Â  Â  Â  Â  }
Â  Â  Â  Â  .todo-text {
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: color 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .todo-done .todo-text {
Â  Â  Â  Â  Â  Â  text-decoration: line-through;
Â  Â  Â  Â  Â  Â  color: #64748b; /* Slate 500 */
Â  Â  Â  Â  }
Â  Â  Â  Â  .todo-delete-btn {
Â  Â  Â  Â  Â  Â  color: #ef4444; /* Red */
Â  Â  Â  Â  Â  Â  opacity: 0.7;
Â  Â  Â  Â  Â  Â  transition: opacity 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .todo-delete-btn:hover {
Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  }
Â  Â  </style>
</head>

<body oncontextmenu="return false;">

Â  Â  <div id="loading-screen" class="fixed inset-0 bg-gray-900 z-[200] flex flex-col items-center justify-center p-8 transition-opacity duration-500 ease-in-out opacity-100 overflow-hidden loading-screen-text">
Â  Â  Â  Â  <div class="text-3xl md:text-4xl font-mono font-semibold text-cyan-400 mb-12 text-center tracking-wider">
Â  Â  Â  Â  Â  Â  KVN.OS // INITIALIZING SHELL
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="w-full max-w-lg bg-gray-800 rounded h-1 border border-gray-700 overflow-hidden">
Â  Â  Â  Â  Â  Â  <div id="loading-bar" class="loading-bar-inner h-full" style="width: 0%;"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="loading-status" class="mt-8 text-sm font-mono p-2 text-gray-400">
Â  Â  Â  Â  Â  Â  [INIT] Initializing system services...
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="boot-log" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-700 text-xs font-mono opacity-20 whitespace-pre-wrap">
Â  Â  Â  Â  Â  Â  Loading kernel v5.18-dev...
Â  Â  Â  Â  Â  Â  Mounting root file system...
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  Â  Â  <div id="os-shell" class="flex flex-col flex-grow h-full w-full hidden">
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="window-container" class="flex-grow relative overflow-hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <footer id="taskbar" class="flex-shrink-0 w-full bg-gray-900 bg-opacity-90 backdrop-blur-sm p-2 shadow-2xl z-50 border-t border-gray-700">
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center max-w-7xl mx-auto">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dropdown relative">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="launcher-button" class="taskbar-item bg-gray-800 hover:bg-gray-700 text-white px-3 py-1 rounded transition duration-200 shadow-md font-semibold flex items-center space-x-2 border border-cyan-700/50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-cyan-400" viewBox="0 0 20 20" fill="currentColor">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Launcher</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="app-launcher-menu" class="hidden absolute bottom-full left-0 mb-2 w-64 bg-gray-800 rounded-lg shadow-xl p-2 border border-cyan-700 z-50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="running-apps" class="flex space-x-2 mx-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="time-display" class="taskbar-item bg-gray-800 text-sm text-gray-300 px-3 py-1 rounded font-mono"></span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </footer>
Â  Â  </div>


Â  Â  Â  Â  <div id="message-box" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-900 p-6 rounded-lg shadow-2xl z-[100] border-t-2 border-cyan-500 text-center">
Â  Â  Â  Â  <p id="message-text" class="text-white mb-4 font-mono"></p>
Â  Â  Â  Â  <button onclick="hideMessage()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white py-2 rounded font-semibold transition duration-200">Acknowledge</button>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // --- Globals ---
Â  Â  Â  Â  const osShell = document.getElementById('os-shell');
Â  Â  Â  Â  const loadingScreen = document.getElementById('loading-screen');
Â  Â  Â  Â  const windowContainer = document.getElementById('window-container');
Â  Â  Â  Â  const runningAppsContainer = document.getElementById('running-apps');
Â  Â  Â  Â  const appLauncherMenu = document.getElementById('app-launcher-menu');
Â  Â  Â  Â  const OS_START_TIME = Date.now();
Â  Â  Â  Â Â 
Â  Â  Â  Â  let lastFrameTime = performance.now();
Â  Â  Â  Â  let frameCount = 0;
Â  Â  Â  Â  let zIndexCounter = 10;
Â  Â  Â  Â  let isMetricsLoopRunning = false;
Â  Â  Â  Â  // Updated activeWindows to store minimized status
Â  Â  Â  Â  const activeWindows = {}; // { id: { element: windowElement, appId: 'metrics', isMinimized: false } }

Â  Â  Â  Â  // --- MUSIC PLAYER STATE (NEW GLOBAL) ---
Â  Â  Â  Â  const musicPlayerState = {
Â  Â  Â  Â  Â  Â  isPlaying: false,
Â  Â  Â  Â  Â  Â  currentTime: 0,
Â  Â  Â  Â  Â  Â  duration: 180, // Mock 3:00 minutes
Â  Â  Â  Â  Â  Â  volume: 75,
Â  Â  Â  Â  Â  Â  trackName: "System_Theme_Loop_A.wav",
Â  Â  Â  Â  Â  Â  intervalId: null,
Â  Â  Â  Â  Â  Â  widgetEl: null, // Holds the micro-player widget element
Â  Â  Â  Â  Â  Â  mainInstanceId: null, // Stores the ID of the main Music Player window
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- APPS Definition (Reordered working apps to the top) ---
Â  Â  Â  Â  const APPS = [
Â  Â  Â  Â  Â  Â  { id: 'metrics', name: 'Dev Metrics Hub', icon: 'ðŸ“ˆ', content: 'metrics', width: 900, height: 600, x: 50, y: 50 },
Â  Â  Â  Â  Â  Â  { id: 'prettyprint', name: 'Java Pretty Printer', icon: 'ðŸ’»', content: 'prettyprinter', width: 600, height: 450, x: 100, y: 100 },
Â  Â  Â  Â  Â  Â  { id: 'music', name: 'Music Player', icon: 'ðŸŽµ', content: 'musicplayer', width: 450, height: 500, x: 150, y: 150 },
Â  Â  Â  Â  Â  Â  { id: 'calculator', name: 'Calculator', icon: 'ðŸ§®', content: 'calculator', width: 320, height: 480, x: 200, y: 200 },
Â  Â  Â  Â  Â  Â  { id: 'todo', name: 'To Do List', icon: 'âœ…', content: 'todolist', width: 400, height: 550, x: 250, y: 250 },
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Remaining Placeholder Apps
Â  Â  Â  Â  Â  Â  { id: 'textedit', name: 'Simple Text Editor', icon: 'ðŸ“', content: 'texteditor', width: 500, height: 350 },
Â  Â  Â  Â  Â  Â  { id: 'calendar', name: 'Calendar', icon: 'ðŸ“…', content: 'placeholder', width: 400, height: 300 },
Â  Â  Â  Â  Â  Â  { id: 'settings', name: 'System Settings', icon: 'âš™ï¸', content: 'placeholder', width: 450, height: 400 },
Â  Â  Â  Â  Â  Â  { id: 'filemgr', name: 'File Manager', icon: 'ðŸ“', content: 'placeholder', width: 700, height: 500 },
Â  Â  Â  Â  Â  Â  { id: 'browser', name: 'Web Browser', icon: 'ðŸŒ', content: 'placeholder', width: 800, height: 600 },
Â  Â  Â  Â  Â  Â  { id: 'chat', name: 'Chat Client', icon: 'ðŸ’¬', content: 'placeholder', width: 500, height: 600 },
Â  Â  Â  Â  Â  Â  { id: 'paint', name: 'Image Painter', icon: 'ðŸŽ¨', content: 'placeholder', width: 700, height: 600 },
Â  Â  Â  Â  Â  Â  { id: 'map', name: 'Map Viewer', icon: 'ðŸ—ºï¸', content: 'placeholder', width: 600, height: 400 },
Â  Â  Â  Â  Â  Â  { id: 'terminal', name: 'Legacy Terminal', icon: 'ðŸ“Ÿ', content: 'placeholder', width: 650, height: 450 },
Â  Â  Â  Â  Â  Â  { id: 'taskmgr', name: 'Task Manager', icon: 'ðŸ›‘', content: 'placeholder', width: 400, height: 550 },
Â  Â  Â  Â  Â  Â  { id: 'photo', name: 'Photo Viewer', icon: 'ðŸ–¼ï¸', content: 'placeholder', width: 500, height: 400 },
Â  Â  Â  Â  Â  Â  { id: 'debugger', name: 'Code Debugger', icon: 'ðŸž', content: 'placeholder', width: 700, height: 500 },
Â  Â  Â  Â  Â  Â  { id: 'network', name: 'Network Monitor', icon: 'ðŸ“¡', content: 'placeholder', width: 550, height: 400 },
Â  Â  Â  Â  Â  Â  { id: 'logs', name: 'System Logs', icon: 'ðŸ“œ', content: 'placeholder', width: 600, height: 400 },
Â  Â  Â  Â  Â  Â  { id: 'notes', name: 'Quick Notes', icon: 'ðŸ“Œ', content: 'placeholder', width: 350, height: 300 },
Â  Â  Â  Â  Â  Â  { id: 'games', name: 'Minesweeper', icon: 'ðŸ’£', content: 'placeholder', width: 350, height: 350 },
Â  Â  Â  Â  ];


Â  Â  Â  Â  // --- Utility Functions ---

Â  Â  Â  Â  function showMessage(message) {
Â  Â  Â  Â  Â  Â  document.getElementById('message-text').innerHTML = message;
Â  Â  Â  Â  Â  Â  document.getElementById('message-box').classList.remove('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  function hideMessage() {
Â  Â  Â  Â  Â  Â  document.getElementById('message-box').classList.add('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateTime() {
Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
Â  Â  Â  Â  Â  Â  const dateString = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: '2-digit' });
Â  Â  Â  Â  Â  Â  document.getElementById('time-display').textContent = `${dateString} | ${timeString}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Update app count metric (if metrics window is open)
Â  Â  Â  Â  Â  Â  if (activeWindows['metrics']) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('metric-time-utc').textContent = now.toUTCString().split(' ')[4];
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('metric-date-local').textContent = now.toLocaleDateString();
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('metric-timezone').textContent = now.toLocaleTimeString('en-us',{timeZoneName:'short'}).split(' ')[2];
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('metric-app-count').textContent = Object.values(activeWindows).filter(w => !w.isMinimized).length;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- OS SHELL: Window Management ---

Â  Â  Â  Â  function focusWindow(windowEl) {
Â  Â  Â  Â  Â  Â  // Check if the element exists and is not minimized
Â  Â  Â  Â  Â  Â  if (!windowEl || windowEl.classList.contains('minimized')) return;

Â  Â  Â  Â  Â  Â  // Unfocus all windows
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.os-window').forEach(win => {
Â  Â  Â  Â  Â  Â  Â  Â  win.classList.remove('focused');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Focus the clicked window
Â  Â  Â  Â  Â  Â  windowEl.classList.add('focused');
Â  Â  Â  Â  Â  Â  zIndexCounter++;
Â  Â  Â  Â  Â  Â  windowEl.style.zIndex = zIndexCounter;
Â  Â  Â  Â  }

Â  Â  Â  Â  // NEW: Minimize function - HOOKED FOR MUSIC PLAYER WIDGET
Â  Â  Â  Â  function minimizeWindow(instanceId) {
Â  Â  Â  Â  Â  Â  const windowData = activeWindows[instanceId];
Â  Â  Â  Â  Â  Â  if (!windowData) return;

Â  Â  Â  Â  Â  Â  windowData.element.classList.add('minimized');
Â  Â  Â  Â  Â  Â  windowData.element.style.display = 'none'; // Hide it
Â  Â  Â  Â  Â  Â  windowData.isMinimized = true;
Â  Â  Â  Â  Â  Â  updateRunningAppsList();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // WIDGET HOOK: Show micro-player if music player is minimized
Â  Â  Â  Â  Â  Â  if (musicPlayerState.mainInstanceId === instanceId) {
Â  Â  Â  Â  Â  Â  Â  Â  showMicroPlayerWidget();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // NEW: Restore function (called from taskbar) - HOOKED FOR MUSIC PLAYER WIDGET
Â  Â  Â  Â  function restoreWindow(instanceId) {
Â  Â  Â  Â  Â  Â  const windowData = activeWindows[instanceId];
Â  Â  Â  Â  Â  Â  if (!windowData) return;

Â  Â  Â  Â  Â  Â  windowData.element.classList.remove('minimized');
Â  Â  Â  Â  Â  Â  windowData.element.style.display = 'block'; // Show it
Â  Â  Â  Â  Â  Â  windowData.isMinimized = false;
Â  Â  Â  Â  Â  Â  focusWindow(windowData.element);
Â  Â  Â  Â  Â  Â  updateRunningAppsList();

Â  Â  Â  Â  Â  Â  // WIDGET HOOK: Hide micro-player if music player is restored
Â  Â  Â  Â  Â  Â  if (musicPlayerState.mainInstanceId === instanceId) {
Â  Â  Â  Â  Â  Â  Â  Â  hideMicroPlayerWidget();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // HOOKED FOR MUSIC PLAYER WIDGET
Â  Â  Â  Â  function closeWindow(instanceId) {
Â  Â  Â  Â  Â  Â  const windowData = activeWindows[instanceId];
Â  Â  Â  Â  Â  Â  if (!windowData) return;

Â  Â  Â  Â  Â  Â  // Stop music playback and hide widget if it's the music player
Â  Â  Â  Â  Â  Â  if (musicPlayerState.mainInstanceId === instanceId) {
Â  Â  Â  Â  Â  Â  Â  Â  stopPlayback();
Â  Â  Â  Â  Â  Â  Â  Â  hideMicroPlayerWidget();
Â  Â  Â  Â  Â  Â  Â  Â  musicPlayerState.mainInstanceId = null;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Remove window element
Â  Â  Â  Â  Â  Â  windowData.element.remove();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Stop metric loop if it was the metrics app being closed
Â  Â  Â  Â  Â  Â  if (windowData.appId === 'metrics' && Object.values(activeWindows).filter(w => w.appId === 'metrics').length === 1) {
Â  Â  Â  Â  Â  Â  Â  Â  isMetricsLoopRunning = false;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Remove from active windows
Â  Â  Â  Â  Â  Â  delete activeWindows[instanceId];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Update running apps list in taskbar
Â  Â  Â  Â  Â  Â  updateRunningAppsList();

Â  Â  Â  Â  Â  Â  // Find the highest z-index and focus it
Â  Â  Â  Â  Â  Â  const remainingWindows = Object.values(activeWindows).map(w => w.element);
Â  Â  Â  Â  Â  Â  if (remainingWindows.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  let maxZIndex = -1;
Â  Â  Â  Â  Â  Â  Â  Â  let topWindow = null;
Â  Â  Â  Â  Â  Â  Â  Â  remainingWindows.forEach(win => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!win.classList.contains('minimized')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const z = parseInt(win.style.zIndex || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (z > maxZIndex) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  maxZIndex = z;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  topWindow = win;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  if (topWindow) focusWindow(topWindow);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function createWindow(appInfo) {
Â  Â  Â  Â  Â  Â  // Generate a unique instance ID for this window
Â  Â  Â  Â  Â  Â  const instanceId = appInfo.id + '-' + Date.now();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- 1. Create Window Element ---
Â  Â  Â  Â  Â  Â  const windowEl = document.createElement('div');
Â  Â  Â  Â  Â  Â  windowEl.id = instanceId;
Â  Â  Â  Â  Â  Â  windowEl.className = 'os-window focused';
Â  Â  Â  Â  Â  Â  windowEl.style.width = `${appInfo.width}px`;
Â  Â  Â  Â  Â  Â  windowEl.style.height = `${appInfo.height}px`;
Â  Â  Â  Â  Â  Â  windowEl.style.left = `${appInfo.x || (Math.random() * 100 + 50)}px`;
Â  Â  Â  Â  Â  Â  windowEl.style.top = `${appInfo.y || (Math.random() * 100 + 50)}px`;

Â  Â  Â  Â  Â  Â  // --- 2. Title Bar and Controls ---
Â  Â  Â  Â  Â  Â  windowEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="window-title-bar p-2 flex justify-between items-center text-sm text-gray-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="flex items-center space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-lg leading-none">${appInfo.icon}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold">${appInfo.name}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="minimizeWindow('${instanceId}')" class="w-6 h-6 rounded-full bg-yellow-500 hover:bg-yellow-600 text-white flex items-center justify-center transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M20 12H4"></path></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="closeWindow('${instanceId}')" class="w-6 h-6 rounded-full bg-red-600 hover:bg-red-700 text-white flex items-center justify-center transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="window-content" id="content-${instanceId}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- 3. Dragging Logic ---
Â  Â  Â  Â  Â  Â  const titleBar = windowEl.querySelector('.window-title-bar');
Â  Â  Â  Â  Â  Â  titleBar.addEventListener('mousedown', (e) => startDrag(e, windowEl));
Â  Â  Â  Â  Â  Â  windowEl.addEventListener('mousedown', () => focusWindow(windowEl));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Add to the container and focus
Â  Â  Â  Â  Â  Â  windowContainer.appendChild(windowEl);
Â  Â  Â  Â  Â  Â  focusWindow(windowEl);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Register and render content
Â  Â  Â  Â  Â  Â  activeWindows[instanceId] = { element: windowEl, appId: appInfo.id, isMinimized: false };
Â  Â  Â  Â  Â  Â  renderAppContent(instanceId, appInfo.content);
Â  Â  Â  Â  Â  Â  updateRunningAppsList();
Â  Â  Â  Â  }

Â  Â  Â  Â  let dragState = { isDragging: false, activeWindow: null, offset: { x: 0, y: 0 } };

Â  Â  Â  Â  function startDrag(e, windowEl) {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  focusWindow(windowEl);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  dragState.isDragging = true;
Â  Â  Â  Â  Â  Â  dragState.activeWindow = windowEl;
Â  Â  Â  Â  Â  Â  dragState.offset.x = e.clientX - windowEl.offsetLeft;
Â  Â  Â  Â  Â  Â  dragState.offset.y = e.clientY - windowEl.offsetTop;

Â  Â  Â  Â  Â  Â  windowEl.style.cursor = 'grabbing';
Â  Â  Â  Â  Â  Â  windowEl.querySelector('.window-title-bar').style.cursor = 'grabbing';
Â  Â  Â  Â  }

Â  Â  Â  Â  function drag(e) {
Â  Â  Â  Â  Â  Â  if (!dragState.isDragging) return;
Â  Â  Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  Â  Â  const win = dragState.activeWindow;
Â  Â  Â  Â  Â  Â  const shellBounds = windowContainer.getBoundingClientRect();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let newLeft = e.clientX - dragState.offset.x;
Â  Â  Â  Â  Â  Â  let newTop = e.clientY - dragState.offset.y;

Â  Â  Â  Â  Â  Â  // Boundary checks
Â  Â  Â  Â  Â  Â  newLeft = Math.max(0, Math.min(newLeft, shellBounds.width - win.offsetWidth));
Â  Â  Â  Â  Â  Â  newTop = Math.max(0, Math.min(newTop, shellBounds.height - win.offsetHeight));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  win.style.left = `${newLeft}px`;
Â  Â  Â  Â  Â  Â  win.style.top = `${newTop}px`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function endDrag() {
Â  Â  Â  Â  Â  Â  if (dragState.isDragging) {
Â  Â  Â  Â  Â  Â  Â  Â  dragState.activeWindow.style.cursor = 'default';
Â  Â  Â  Â  Â  Â  Â  Â  dragState.activeWindow.querySelector('.window-title-bar').style.cursor = 'grab';
Â  Â  Â  Â  Â  Â  Â  Â  dragState.isDragging = false;
Â  Â  Â  Â  Â  Â  Â  Â  dragState.activeWindow = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  document.addEventListener('mousemove', drag);
Â  Â  Â  Â  document.addEventListener('mouseup', endDrag);

Â  Â  Â  Â  // --- OS SHELL: Taskbar/Launcher Management ---

Â  Â  Â  Â  function toggleLauncherMenu() {
Â  Â  Â  Â  Â  Â  appLauncherMenu.classList.toggle('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  document.getElementById('launcher-button').addEventListener('click', toggleLauncherMenu);
Â  Â  Â  Â  // Hide launcher when clicking outside
Â  Â  Â  Â  document.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  if (!document.getElementById('launcher-button').contains(e.target) && !appLauncherMenu.contains(e.target)) {
Â  Â  Â  Â  Â  Â  Â  Â  appLauncherMenu.classList.add('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  function createLauncherMenu() {
Â  Â  Â  Â  Â  Â  APPS.forEach(app => {
Â  Â  Â  Â  Â  Â  Â  Â  const button = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  button.className = 'w-full text-left p-2 rounded flex items-center space-x-3 hover:bg-gray-700 transition duration-150';
Â  Â  Â  Â  Â  Â  Â  Â  button.innerHTML = `<span class="text-xl">${app.icon}</span> <span>${app.name}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  button.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createWindow(app);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appLauncherMenu.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  appLauncherMenu.appendChild(button);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateRunningAppsList() {
Â  Â  Â  Â  Â  Â  runningAppsContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Group by app ID (in case multiple instances are open)
Â  Â  Â  Â  Â  Â  const runningAppInstances = Object.values(activeWindows);
Â  Â  Â  Â  Â  Â  const uniqueAppIds = [...new Set(runningAppInstances.map(w => w.appId))];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  uniqueAppIds.forEach(appId => {
Â  Â  Â  Â  Â  Â  Â  Â  const appInfo = APPS.find(app => app.id === appId);
Â  Â  Â  Â  Â  Â  Â  Â  const instances = runningAppInstances.filter(w => w.appId === appId);
Â  Â  Â  Â  Â  Â  Â  Â  const isMinimized = instances.every(w => w.isMinimized);

Â  Â  Â  Â  Â  Â  Â  Â  const button = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Color change if all instances are minimized
Â  Â  Â  Â  Â  Â  Â  Â  const baseClasses = 'taskbar-item px-3 py-1 rounded transition duration-200 shadow-md font-semibold text-sm flex items-center space-x-2';
Â  Â  Â  Â  Â  Â  Â  Â  button.className = isMinimizedÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? baseClasses + ' bg-gray-700 hover:bg-gray-600 text-gray-400 border border-gray-500'Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : baseClasses + ' bg-cyan-800 hover:bg-cyan-700 text-white border border-cyan-500';

Â  Â  Â  Â  Â  Â  Â  Â  button.innerHTML = `<span class="text-lg leading-none">${appInfo.icon}</span><span>${appInfo.name}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Clicking running app button restores/focuses
Â  Â  Â  Â  Â  Â  Â  Â  button.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const instancesKeys = Object.keys(activeWindows).filter(key => activeWindows[key].appId === appId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (instancesKeys.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const topInstanceKey = instancesKeys.reduce((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const zA = parseInt(activeWindows[a].element.style.zIndex || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const zB = parseInt(activeWindows[b].element.style.zIndex || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return zA > zB ? a : b;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const topWindowData = activeWindows[topInstanceKey];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (topWindowData.isMinimized) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  restoreWindow(topInstanceKey);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  focusWindow(topWindowData.element);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  runningAppsContainer.appendChild(button);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- APP CONTENT RENDERING ---

Â  Â  Â  Â  function renderAppContent(instanceId, contentType) {
Â  Â  Â  Â  Â  Â  const contentEl = document.getElementById(`content-${instanceId}`);
Â  Â  Â  Â  Â  Â  if (!contentEl) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Clear content and ensure padding is correct before rendering
Â  Â  Â  Â  Â  Â  contentEl.innerHTML = '';
Â  Â  Â  Â  Â  Â  contentEl.classList.add('p-4');Â 

Â  Â  Â  Â  Â  Â  switch (contentType) {
Â  Â  Â  Â  Â  Â  Â  Â  case 'metrics':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentEl.classList.remove('p-4'); // Metrics uses its own internal padding
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderMetricsApp(contentEl);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isMetricsLoopRunning) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startMetricsLoop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'prettyprinter':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderPrettyPrinter(contentEl);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'musicplayer':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderMusicPlayer(contentEl, instanceId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'calculator':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderCalculator(contentEl, instanceId); // Pass instanceId for state isolation
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'todolist':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderToDoList(contentEl, instanceId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'texteditor':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderTextEditor(contentEl);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'placeholder':
Â  Â  Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderPlaceholderApp(contentEl, APPS.find(a => a.id === activeWindows[instanceId].appId)?.name);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- WIDGET DRAG LOGIC (NEW) ---
Â  Â  Â  Â  let widgetDragState = { isDragging: false, offset: { x: 0, y: 0 }, widgetEl: null };

Â  Â  Â  Â  function startWidgetDrag(e, widgetEl) {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  // Only drag if the click is on the main widget body (not the button)
Â  Â  Â  Â  Â  Â  if (e.target.closest('#widget-play-btn') === null) {
Â  Â  Â  Â  Â  Â  Â  Â  widgetDragState.isDragging = true;
Â  Â  Â  Â  Â  Â  Â  Â  widgetDragState.widgetEl = widgetEl;
Â  Â  Â  Â  Â  Â  Â  Â  const rect = widgetEl.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  Â  Â  widgetDragState.offset.x = e.clientX - rect.left;
Â  Â  Â  Â  Â  Â  Â  Â  widgetDragState.offset.y = e.clientY - rect.top;

Â  Â  Â  Â  Â  Â  Â  Â  // Attach listeners to the document to allow dragging outside the widget
Â  Â  Â  Â  Â  Â  Â  Â  document.addEventListener('mousemove', dragWidget);
Â  Â  Â  Â  Â  Â  Â  Â  document.addEventListener('mouseup', endWidgetDrag);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function dragWidget(e) {
Â  Â  Â  Â  Â  Â  if (!widgetDragState.isDragging) return;
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const widgetEl = widgetDragState.widgetEl;
Â  Â  Â  Â  Â  Â  const offset = widgetDragState.offset;
Â  Â  Â  Â  Â  Â  const maxX = window.innerWidth - widgetEl.offsetWidth;
Â  Â  Â  Â  Â  Â  const maxY = window.innerHeight - widgetEl.offsetHeight - 50; // Above taskbar

Â  Â  Â  Â  Â  Â  // Calculate new position and clamp to viewport edges
Â  Â  Â  Â  Â  Â  let newX = Math.min(Math.max(0, e.clientX - offset.x), maxX);
Â  Â  Â  Â  Â  Â  let newY = Math.min(Math.max(0, e.clientY - offset.y), maxY);

Â  Â  Â  Â  Â  Â  // Apply new coordinates
Â  Â  Â  Â  Â  Â  widgetEl.style.position = 'fixed';
Â  Â  Â  Â  Â  Â  widgetEl.style.right = 'auto';
Â  Â  Â  Â  Â  Â  widgetEl.style.top = 'auto';

Â  Â  Â  Â  Â  Â  widgetEl.style.left = `${newX}px`;
Â  Â  Â  Â  Â  Â  widgetEl.style.top = `${newY}px`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function endWidgetDrag() {
Â  Â  Â  Â  Â  Â  if (widgetDragState.isDragging) {
Â  Â  Â  Â  Â  Â  Â  Â  widgetDragState.isDragging = false;
Â  Â  Â  Â  Â  Â  Â  Â  document.removeEventListener('mousemove', dragWidget);
Â  Â  Â  Â  Â  Â  Â  Â  document.removeEventListener('mouseup', endWidgetDrag);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- 1. Dev Metrics Hub (Metrics Content) ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  function getMetricEl(id) {
Â  Â  Â  Â  Â  Â  const windowData = Object.values(activeWindows).find(w => w.appId === 'metrics');
Â  Â  Â  Â  Â  Â  if (!windowData) return null;
Â  Â  Â  Â  Â  Â  return windowData.element.querySelector(`#${id}`);
Â  Â  Â  Â  }
Â  Â  Â  Â  // (Helper functions for metrics loop retained for brevity)
Â  Â  Â  Â  function formatUptime(ms) {
Â  Â  Â  Â  Â  Â  const totalSeconds = Math.floor(ms / 1000);
Â  Â  Â  Â  Â  Â  const days = Math.floor(totalSeconds / (3600 * 24));
Â  Â  Â  Â  Â  Â  const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
Â  Â  Â  Â  Â  Â  const minutes = Math.floor((totalSeconds % 3600) / 60);
Â  Â  Â  Â  Â  Â  const seconds = totalSeconds % 60;
Â  Â  Â  Â  Â  Â  return `${days.toString().padStart(2, '0')}d ${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateMetrics() {
Â  Â  Â  Â  Â  Â  if (!isMetricsLoopRunning) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const now = performance.now();
Â  Â  Â  Â  Â  Â  const frameTime = now - lastFrameTime;
Â  Â  Â  Â  Â  Â  lastFrameTime = now;
Â  Â  Â  Â  Â  Â  frameCount++;

Â  Â  Â  Â  Â  Â  // 1. Performance Metrics
Â  Â  Â  Â  Â  Â  const fps = Math.round(1000 / frameTime);
Â  Â  Â  Â  Â  Â  const uptime = formatUptime(Date.now() - OS_START_TIME);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let memoryInfo = {};
Â  Â  Â  Â  Â  Â  if (window.performance && window.performance.memory) {
Â  Â  Â  Â  Â  Â  Â  Â  memoryInfo = window.performance.memory;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const heapUsed = (memoryInfo.usedJSHeapSize / 1048576 || 0).toFixed(2);
Â  Â  Â  Â  Â  Â  const heapTotal = (memoryInfo.totalJSHeapSize / 1048576 || 0).toFixed(2);
Â  Â  Â  Â  Â  Â  const heapLimit = (memoryInfo.jsHeapSizeLimit / 1048576 || 0).toFixed(0);

Â  Â  Â  Â  Â  Â  const dnsMock = (Math.random() * 50 + 5).toFixed(1);
Â  Â  Â  Â  Â  Â  const loadTimeMock = (now + Math.random() * 500).toFixed(0); // Mocking initial load time

Â  Â  Â  Â  Â  Â  const fpsEl = getMetricEl('metric-fps');
Â  Â  Â  Â  Â  Â  if (fpsEl) fpsEl.textContent = Math.min(fps, 60);

Â  Â  Â  Â  Â  Â  const usedEl = getMetricEl('metric-heap-used');
Â  Â  Â  Â  Â  Â  if (usedEl) usedEl.textContent = heapUsed;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // >>> FIX APPLIED HERE <<<
Â  Â  Â  Â  Â  Â  const totalEl = getMetricEl('metric-heap-total');
Â  Â  Â  Â  Â  Â  if (totalEl) totalEl.textContent = heapTotal;

Â  Â  Â  Â  Â  Â  const limitEl = getMetricEl('metric-heap-limit');
Â  Â  Â  Â  Â  Â  if (limitEl) limitEl.textContent = heapLimit;

Â  Â  Â  Â  Â  Â  const uptimeEl = getMetricEl('metric-uptime');
Â  Â  Â  Â  Â  Â  if (uptimeEl) uptimeEl.textContent = uptime;

Â  Â  Â  Â  Â  Â  const dnsEl = getMetricEl('metric-network-dns');
Â  Â  Â  Â  Â  Â  if (dnsEl) dnsEl.textContent = dnsMock;

Â  Â  Â  Â  Â  Â  const loadEl = getMetricEl('metric-page-load');
Â  Â  Â  Â  Â  Â  if (loadEl) loadEl.textContent = loadTimeMock;

Â  Â  Â  Â  Â  Â  // Browser Info Metrics (Handles potential missing userAgentData)
Â  Â  Â  Â  Â  Â  const browserEl = getMetricEl('metric-browser');
Â  Â  Â  Â  Â  Â  if (browserEl) {
Â  Â  Â  Â  Â  Â  Â  Â  // Fallback to userAgent if userAgentData is not available
Â  Â  Â  Â  Â  Â  Â  Â  let browserName = 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  if (navigator.userAgentData) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  browserName = navigator.userAgentData.brands[0]?.brand || 'Unknown';
Â  Â  Â  Â  Â  Â  Â  Â  } else if (navigator.userAgent) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (navigator.userAgent.indexOf("Chrome") != -1) browserName = "Chrome";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (navigator.userAgent.indexOf("Firefox") != -1) browserName = "Firefox";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (navigator.userAgent.indexOf("Safari") != -1) browserName = "Safari";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (navigator.userAgent.indexOf("MSIE") != -1 || navigator.userAgent.indexOf("Trident") != -1) browserName = "IE/Edge";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else browserName = "Other";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  browserEl.textContent = browserName;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Update Progress Bar
Â  Â  Â  Â  Â  Â  const heapUsagePercent = (heapUsed / heapLimit) * 100;
Â  Â  Â  Â  Â  Â  const progressFillEl = getMetricEl('metric-memory-progress');
Â  Â  Â  Â  Â  Â  if (progressFillEl) progressFillEl.style.width = `${heapUsagePercent.toFixed(0)}%`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function startMetricsLoop() {
Â  Â  Â  Â  Â  Â  isMetricsLoopRunning = true;
Â  Â  Â  Â  Â  Â  function loop() {
Â  Â  Â  Â  Â  Â  Â  Â  if (isMetricsLoopRunning) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateMetrics();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  requestAnimationFrame(loop);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  requestAnimationFrame(loop);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderMetricsApp(contentEl) {
Â  Â  Â  Â  Â  Â  contentEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-6 h-full flex flex-col space-y-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-cyan-400 border-b border-gray-700 pb-2">System Health Overview</h3>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-4 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-card p-3 rounded-lg flex flex-col justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="metric-fps" class="metric-value text-3xl">--</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">FPS</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-card p-3 rounded-lg flex flex-col justify-center col-span-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="metric-uptime" class="metric-value text-xl">--</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Uptime</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-card p-3 rounded-lg flex flex-col justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="metric-app-count" class="metric-value text-3xl">--</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Apps Active</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-lg font-semibold text-gray-300">Heap Memory (MB)</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-bar">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="metric-memory-progress" class="progress-bar-fill" style="width: 0%;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between font-mono text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Used: <span id="metric-heap-used" class="text-green-400">0.00</span> MB</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Total: <span id="metric-heap-total" class="text-cyan-400">0.00</span> MB</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Limit: <span id="metric-heap-limit" class="text-red-400">0</span> MB</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-lg font-semibold text-gray-300 pt-2">Detailed Diagnostics</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-gray-800 p-4 rounded-lg overflow-x-auto font-mono text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="w-full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="border-b border-gray-700"><td class="py-1 text-gray-400">Browser/Engine:</td><td class="py-1 text-cyan-400" id="metric-browser">--</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="border-b border-gray-700"><td class="py-1 text-gray-400">DNS Lookup (Mock):</td><td class="py-1 text-green-400" id="metric-network-dns">-- ms</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="border-b border-gray-700"><td class="py-1 text-gray-400">Initial Page Load:</td><td class="py-1 text-green-400" id="metric-page-load">-- ms</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="border-b border-gray-700"><td class="py-1 text-gray-400">Local Date:</td><td class="py-1" id="metric-date-local">--</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="border-b border-gray-700"><td class="py-1 text-gray-400">Timezone:</td><td class="py-1" id="metric-timezone">--</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="border-b border-gray-700"><td class="py-1 text-gray-400">Current UTC Time:</td><td class="py-1" id="metric-time-utc">--</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 2. Java Pretty Printer (Code Formatter) ---

Â  Â  Â  Â  function formatJavaCode(code) {
Â  Â  Â  Â  Â  Â  // Simple indentation logic for demonstration
Â  Â  Â  Â  Â  Â  let indent = 0;
Â  Â  Â  Â  Â  Â  return code.split('\n').map(line => {
Â  Â  Â  Â  Â  Â  Â  Â  line = line.trim();
Â  Â  Â  Â  Â  Â  Â  Â  if (line.endsWith('}')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  indent = Math.max(0, indent - 1);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const paddedLine = 'Â  '.repeat(indent) + line;
Â  Â  Â  Â  Â  Â  Â  Â  if (line.endsWith('{')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  indent++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return paddedLine;
Â  Â  Â  Â  Â  Â  }).join('\n');
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderPrettyPrinter(contentEl) {
Â  Â  Â  Â  Â  Â  const initialCode = `public class Main {
public static void main(String[] args) {
int x=5;
if(x>0){
System.out.println("Hello World!");
}
}
}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  contentEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="h-full flex flex-col space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-lg font-semibold text-cyan-400">Input (Ugly Java Code):</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="code-input" class="code-input flex-grow" rows="10">${initialCode}</textarea>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="format-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded transition duration-200 flex items-center space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M10 3a1 1 0 011 1v1h4a1 1 0 110 2h-4v1h5a1 1 0 110 2h-5v1h4a1 1 0 110 2h-4v1a1 1 0 11-2 0v-1h-5a1 1 0 110-2h5v-1h-4a1 1 0 110-2h4v-1h-5a1 1 0 110-2h5V4a1 1 0 011-1z" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Format Code</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-lg font-semibold text-gray-300">Output (Pretty Code):</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="code-output" class="code-output flex-grow" rows="10" readonly></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  document.getElementById('format-button').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  const input = document.getElementById('code-input').value;
Â  Â  Â  Â  Â  Â  Â  Â  const output = formatJavaCode(input);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('code-output').value = output;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // Run once on load
Â  Â  Â  Â  Â  Â  document.getElementById('code-output').value = formatJavaCode(initialCode);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 3. Music Player ---

Â  Â  Â  Â  function formatTime(seconds) {
Â  Â  Â  Â  Â  Â  const min = Math.floor(seconds / 60);
Â  Â  Â  Â  Â  Â  const sec = Math.floor(seconds % 60).toString().padStart(2, '0');
Â  Â  Â  Â  Â  Â  return `${min}:${sec}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateMusicPlayerUI(instanceId) {
Â  Â  Â  Â  Â  Â  const windowEl = activeWindows[instanceId]?.element;
Â  Â  Â  Â  Â  Â  if (!windowEl) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const playBtn = windowEl.querySelector('#play-pause-btn');
Â  Â  Â  Â  Â  Â  const timeCurrentEl = windowEl.querySelector('#time-current');
Â  Â  Â  Â  Â  Â  const timeTotalEl = windowEl.querySelector('#time-total');
Â  Â  Â  Â  Â  Â  const progressRange = windowEl.querySelector('#progress-range');

Â  Â  Â  Â  Â  Â  if (playBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  playBtn.innerHTML = musicPlayerState.isPlaying
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 011-1h1a1 1 0 011 1v4a1 1 0 01-1 1H8a1 1 0 01-1-1V8zm5-1a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1h-1z" clip-rule="evenodd" /></svg>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (timeCurrentEl) timeCurrentEl.textContent = formatTime(musicPlayerState.currentTime);
Â  Â  Â  Â  Â  Â  if (timeTotalEl) timeTotalEl.textContent = formatTime(musicPlayerState.duration);

Â  Â  Â  Â  Â  Â  if (progressRange) {
Â  Â  Â  Â  Â  Â  Â  Â  progressRange.value = musicPlayerState.currentTime;
Â  Â  Â  Â  Â  Â  Â  Â  progressRange.max = musicPlayerState.duration;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const volumeRange = windowEl.querySelector('#volume-range');
Â  Â  Â  Â  Â  Â  if (volumeRange) volumeRange.value = musicPlayerState.volume;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const volumeValueEl = windowEl.querySelector('#volume-value');
Â  Â  Â  Â  Â  Â  if (volumeValueEl) volumeValueEl.textContent = musicPlayerState.volume + '%';

Â  Â  Â  Â  Â  Â  // Update Widget
Â  Â  Â  Â  Â  Â  updateMicroPlayerWidget();
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateMicroPlayerWidget() {
Â  Â  Â  Â  Â  Â  const widgetEl = musicPlayerState.widgetEl;
Â  Â  Â  Â  Â  Â  if (!widgetEl) return;

Â  Â  Â  Â  Â  Â  const trackEl = widgetEl.querySelector('#widget-track-name');
Â  Â  Â  Â  Â  Â  const timeEl = widgetEl.querySelector('#widget-time');
Â  Â  Â  Â  Â  Â  const btn = widgetEl.querySelector('#widget-play-btn');

Â  Â  Â  Â  Â  Â  if (trackEl) trackEl.textContent = musicPlayerState.trackName;
Â  Â  Â  Â  Â  Â  if (timeEl) timeEl.textContent = formatTime(musicPlayerState.currentTime);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (btn) {
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerHTML = musicPlayerState.isPlaying
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM9 8a1 1 0 012 0v4a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>`;
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.toggle('bg-gray-600', !musicPlayerState.isPlaying);
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.toggle('bg-green-600', musicPlayerState.isPlaying);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function startPlayback(instanceId) {
Â  Â  Â  Â  Â  Â  if (musicPlayerState.isPlaying) return;
Â  Â  Â  Â  Â  Â  musicPlayerState.isPlaying = true;

Â  Â  Â  Â  Â  Â  const updateLoop = () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!musicPlayerState.isPlaying) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(musicPlayerState.intervalId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  musicPlayerState.currentTime++;
Â  Â  Â  Â  Â  Â  Â  Â  if (musicPlayerState.currentTime >= musicPlayerState.duration) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  musicPlayerState.currentTime = 0; // Loop track
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  updateMusicPlayerUI(instanceId || musicPlayerState.mainInstanceId);
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  musicPlayerState.intervalId = setInterval(updateLoop, 1000);
Â  Â  Â  Â  Â  Â  updateMusicPlayerUI(instanceId || musicPlayerState.mainInstanceId);
Â  Â  Â  Â  }

Â  Â  Â  Â  function pausePlayback(instanceId) {
Â  Â  Â  Â  Â  Â  if (!musicPlayerState.isPlaying) return;
Â  Â  Â  Â  Â  Â  musicPlayerState.isPlaying = false;
Â  Â  Â  Â  Â  Â  clearInterval(musicPlayerState.intervalId);
Â  Â  Â  Â  Â  Â  updateMusicPlayerUI(instanceId || musicPlayerState.mainInstanceId);
Â  Â  Â  Â  }

Â  Â  Â  Â  function stopPlayback() {
Â  Â  Â  Â  Â  Â  pausePlayback();
Â  Â  Â  Â  Â  Â  musicPlayerState.currentTime = 0;
Â  Â  Â  Â  Â  Â  updateMusicPlayerUI(musicPlayerState.mainInstanceId);
Â  Â  Â  Â  }

Â  Â  Â  Â  function togglePlayPause(instanceId) {
Â  Â  Â  Â  Â  Â  if (musicPlayerState.isPlaying) {
Â  Â  Â  Â  Â  Â  Â  Â  pausePlayback(instanceId);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  startPlayback(instanceId);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function showMicroPlayerWidget() {
Â  Â  Â  Â  Â  Â  if (musicPlayerState.widgetEl) {
Â  Â  Â  Â  Â  Â  Â  Â  musicPlayerState.widgetEl.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  updateMicroPlayerWidget();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Create Widget Element
Â  Â  Â  Â  Â  Â  const widgetEl = document.createElement('div');
Â  Â  Â  Â  Â  Â  widgetEl.id = 'music-widget';
Â  Â  Â  Â  Â  Â  widgetEl.className = 'fixed right-4 bottom-16 w-64 bg-gray-900 border border-cyan-500 rounded-lg shadow-2xl p-3 z-40 text-sm cursor-move';
Â  Â  Â  Â  Â  Â  widgetEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-3" onmousedown="startWidgetDrag(event, this.parentNode)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="widget-play-btn" onclick="togglePlayPause()" class="w-8 h-8 rounded-full bg-green-600 hover:bg-green-500 text-white flex items-center justify-center transition duration-150"></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow min-w-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="widget-track-name" class="font-semibold truncate text-cyan-400">Track Name</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="widget-time" class="text-xs text-gray-400 font-mono">0:00</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="restoreWindow('${musicPlayerState.mainInstanceId}')" class="text-gray-400 hover:text-white transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zM6.586 7.414A2 2 0 1010 11.828V10a1 1 0 012 0v1.828a2 2 0 103.414-3.414L10 2z" /></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.body.appendChild(widgetEl);
Â  Â  Â  Â  Â  Â  musicPlayerState.widgetEl = widgetEl;
Â  Â  Â  Â  Â  Â  updateMicroPlayerWidget();
Â  Â  Â  Â  }

Â  Â  Â  Â  function hideMicroPlayerWidget() {
Â  Â  Â  Â  Â  Â  if (musicPlayerState.widgetEl) {
Â  Â  Â  Â  Â  Â  Â  Â  musicPlayerState.widgetEl.classList.add('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderMusicPlayer(contentEl, instanceId) {
Â  Â  Â  Â  Â  Â  // Ensure only one main music player window can exist
Â  Â  Â  Â  Â  Â  if (musicPlayerState.mainInstanceId) {
Â  Â  Â  Â  Â  Â  Â  Â  contentEl.innerHTML = `<p class="text-yellow-500">Music player is already open. Close the existing window to open a new one.</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => closeWindow(instanceId), 3000);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  musicPlayerState.mainInstanceId = instanceId;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  contentEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="h-full flex flex-col items-center justify-center space-y-6 p-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-8xl text-cyan-500">ðŸŽµ</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="track-name" class="text-xl font-bold text-center">${musicPlayerState.trackName}</div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="w-full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="range" id="progress-range" min="0" max="${musicPlayerState.duration}" value="${musicPlayerState.currentTime}" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between text-xs font-mono text-gray-400 mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="time-current">${formatTime(musicPlayerState.currentTime)}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="time-total">${formatTime(musicPlayerState.duration)}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-6 items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="stopPlayback()" class="text-gray-400 hover:text-white transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 002 0V8a1 1 0 00-1-1zm3 1a1 1 0 011 1v2a1 1 0 11-2 0V9a1 1 0 011-1z" clip-rule="evenodd" /></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="play-pause-btn" onclick="togglePlayPause('${instanceId}')" class="text-white bg-cyan-600 hover:bg-cyan-500 p-2 rounded-full shadow-lg transition duration-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showMessage('Skipping track...')" class="text-gray-400 hover:text-white transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM13 7a1 1 0 00-1-1h-2a1 1 0 000 2h1.586l-3.293 3.293a1 1 0 001.414 1.414L12 9.414V11a1 1 0 102 0V7z" clip-rule="evenodd" /></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="w-full flex items-center space-x-3 pt-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.383 3.037A.75.75 0 008.75 3h-1.393A.25.25 0 007 3.25V4.75a.25.25 0 00.353.228l1.393-.787a.75.75 0 00.654-.228zM7 7.25a.25.25 0 00.353.228l1.393-.787a.75.75 0 00.654-.228zM15 10a5 5 0 11-10 0 5 5 0 0110 0z" clip-rule="evenodd" /></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="range" id="volume-range" min="0" max="100" value="${musicPlayerState.volume}" class="flex-grow h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer range-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="volume-value" class="text-sm font-mono">${musicPlayerState.volume}%</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  // Setup listeners
Â  Â  Â  Â  Â  Â  const volumeRange = contentEl.querySelector('#volume-range');
Â  Â  Â  Â  Â  Â  if (volumeRange) {
Â  Â  Â  Â  Â  Â  Â  Â  volumeRange.addEventListener('input', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  musicPlayerState.volume = e.target.value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateMusicPlayerUI(instanceId);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const progressRange = contentEl.querySelector('#progress-range');
Â  Â  Â  Â  Â  Â  if (progressRange) {
Â  Â  Â  Â  Â  Â  Â  Â  progressRange.addEventListener('input', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  musicPlayerState.currentTime = parseInt(e.target.value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateMusicPlayerUI(instanceId);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Initial UI update
Â  Â  Â  Â  Â  Â  updateMusicPlayerUI(instanceId);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 4. Calculator ---
Â  Â  Â  Â  const calculatorStates = {}; // { instanceId: { displayValue: '0', operator: null, firstOperand: null, waitingForSecondOperand: false } }

Â  Â  Â  Â  function updateCalculatorDisplay(instanceId) {
Â  Â  Â  Â  Â  Â  const state = calculatorStates[instanceId];
Â  Â  Â  Â  Â  Â  if (!state) return;
Â  Â  Â  Â  Â  Â  const displayEl = activeWindows[instanceId].element.querySelector('#calc-display');
Â  Â  Â  Â  Â  Â  if (displayEl) displayEl.textContent = state.displayValue;
Â  Â  Â  Â  }

Â  Â  Â  Â  function inputDigit(instanceId, digit) {
Â  Â  Â  Â  Â  Â  const state = calculatorStates[instanceId];
Â  Â  Â  Â  Â  Â  const { displayValue, waitingForSecondOperand } = state;

Â  Â  Â  Â  Â  Â  if (waitingForSecondOperand === true) {
Â  Â  Â  Â  Â  Â  Â  Â  state.displayValue = digit;
Â  Â  Â  Â  Â  Â  Â  Â  state.waitingForSecondOperand = false;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  state.displayValue = displayValue === '0' ? digit : displayValue + digit;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateCalculatorDisplay(instanceId);
Â  Â  Â  Â  }

Â  Â  Â  Â  function inputDecimal(instanceId) {
Â  Â  Â  Â  Â  Â  const state = calculatorStates[instanceId];
Â  Â  Â  Â  Â  Â  if (state.waitingForSecondOperand === true) return;

Â  Â  Â  Â  Â  Â  if (!state.displayValue.includes('.')) {
Â  Â  Â  Â  Â  Â  Â  Â  state.displayValue += '.';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateCalculatorDisplay(instanceId);
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleOperator(instanceId, nextOperator) {
Â  Â  Â  Â  Â  Â  const state = calculatorStates[instanceId];
Â  Â  Â  Â  Â  Â  const inputValue = parseFloat(state.displayValue);

Â  Â  Â  Â  Â  Â  if (state.operator && state.waitingForSecondOperand) {
Â  Â  Â  Â  Â  Â  Â  Â  state.operator = nextOperator;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (state.firstOperand === null) {
Â  Â  Â  Â  Â  Â  Â  Â  state.firstOperand = inputValue;
Â  Â  Â  Â  Â  Â  } else if (state.operator) {
Â  Â  Â  Â  Â  Â  Â  Â  const result = performCalculation(state.firstOperand, inputValue, state.operator);
Â  Â  Â  Â  Â  Â  Â  Â  state.displayValue = String(result);
Â  Â  Â  Â  Â  Â  Â  Â  state.firstOperand = result;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  state.waitingForSecondOperand = true;
Â  Â  Â  Â  Â  Â  state.operator = nextOperator;
Â  Â  Â  Â  Â  Â  updateCalculatorDisplay(instanceId);
Â  Â  Â  Â  }

Â  Â  Â  Â  function performCalculation(firstOperand, secondOperand, operator) {
Â  Â  Â  Â  Â  Â  switch (operator) {
Â  Â  Â  Â  Â  Â  Â  Â  case '+': return firstOperand + secondOperand;
Â  Â  Â  Â  Â  Â  Â  Â  case '-': return firstOperand - secondOperand;
Â  Â  Â  Â  Â  Â  Â  Â  case '*': return firstOperand * secondOperand;
Â  Â  Â  Â  Â  Â  Â  Â  case '/': return firstOperand / secondOperand;
Â  Â  Â  Â  Â  Â  Â  Â  default: return secondOperand;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function resetCalculator(instanceId) {
Â  Â  Â  Â  Â  Â  calculatorStates[instanceId] = {
Â  Â  Â  Â  Â  Â  Â  Â  displayValue: '0',
Â  Â  Â  Â  Â  Â  Â  Â  operator: null,
Â  Â  Â  Â  Â  Â  Â  Â  firstOperand: null,
Â  Â  Â  Â  Â  Â  Â  Â  waitingForSecondOperand: false,
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  updateCalculatorDisplay(instanceId);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderCalculator(contentEl, instanceId) {
Â  Â  Â  Â  Â  Â  // Initialize state for this instance
Â  Â  Â  Â  Â  Â  resetCalculator(instanceId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  contentEl.classList.remove('p-4');
Â  Â  Â  Â  Â  Â  contentEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 h-full flex flex-col justify-end">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="calc-display" class="calc-display">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-4 gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="calc-button bg-red-600 hover:bg-red-700 col-span-2" data-action="clear">AC</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="calc-button calc-op" data-action="operator" data-value="/">&divide;</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="calc-button calc-op" data-action="operator" data-value="*">&times;</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="calc-button" data-action="number" data-value="7">7</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="calc-button" data-action="number" data-value="8">8</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="calc-button" data-action="number" data-value="9">9</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="calc-button calc-op" data-action="operator" data-value="-">-</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="calc-button" data-action="number" data-value="4">4</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="calc-button" data-action="number" data-value="5">5</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="calc-button" data-action="number" data-value="6">6</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="calc-button calc-op" data-action="operator" data-value="+">+</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="calc-button" data-action="number" data-value="1">1</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="calc-button" data-action="number" data-value="2">2</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="calc-button" data-action="number" data-value="3">3</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="calc-button calc-eq row-span-2" data-action="operator" data-value="=">=</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="calc-button col-span-2" data-action="number" data-value="0">0</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="calc-button" data-action="decimal" data-value=".">.</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  contentEl.addEventListener('click', (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!event.target.matches('.calc-button')) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const button = event.target;
Â  Â  Â  Â  Â  Â  Â  Â  const action = button.dataset.action;
Â  Â  Â  Â  Â  Â  Â  Â  const value = button.dataset.value;

Â  Â  Â  Â  Â  Â  Â  Â  switch (action) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'number':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  inputDigit(instanceId, value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'decimal':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  inputDecimal(instanceId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'clear':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetCalculator(instanceId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'operator':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleOperator(instanceId, value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 5. To Do List ---
Â  Â  Â  Â  const todoLists = {}; // { instanceId: [ { id: 1, text: '...', done: false } ] }

Â  Â  Â  Â  function saveToDoList(instanceId) {
Â  Â  Â  Â  Â  Â  // Simple mock: in a real app, this would save to localStorage/DB
Â  Â  Â  Â  Â  Â  // console.log(`To Do List for ${instanceId} saved.`);
Â  Â  Â  Â  }

Â  Â  Â  Â  function drawToDoList(instanceId) {
Â  Â  Â  Â  Â  Â  const windowEl = activeWindows[instanceId]?.element;
Â  Â  Â  Â  Â  Â  if (!windowEl) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const listContainer = windowEl.querySelector('#todo-list-items');
Â  Â  Â  Â  Â  Â  const list = todoLists[instanceId] || [];
Â  Â  Â  Â  Â  Â  listContainer.innerHTML = '';

Â  Â  Â  Â  Â  Â  list.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  const itemEl = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  itemEl.className = `todo-item ${item.done ? 'todo-done' : ''}`;
Â  Â  Â  Â  Â  Â  Â  Â  itemEl.id = `todo-${item.id}`;
Â  Â  Â  Â  Â  Â  Â  Â  itemEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="todo-text flex-grow mr-4" data-id="${item.id}">${item.text}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="todo-delete-btn" data-id="${item.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  listContainer.appendChild(itemEl);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  saveToDoList(instanceId);
Â  Â  Â  Â  }

Â  Â  Â  Â  function addToDoItem(instanceId) {
Â  Â  Â  Â  Â  Â  const windowEl = activeWindows[instanceId]?.element;
Â  Â  Â  Â  Â  Â  if (!windowEl) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const inputEl = windowEl.querySelector('#new-todo-input');
Â  Â  Â  Â  Â  Â  const text = inputEl.value.trim();

Â  Â  Â  Â  Â  Â  if (text) {
Â  Â  Â  Â  Â  Â  Â  Â  todoLists[instanceId].push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: Date.now(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: text,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  done: false
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  inputEl.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  drawToDoList(instanceId);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function toggleToDoItem(instanceId, id) {
Â  Â  Â  Â  Â  Â  const item = todoLists[instanceId].find(i => i.id == id);
Â  Â  Â  Â  Â  Â  if (item) {
Â  Â  Â  Â  Â  Â  Â  Â  item.done = !item.done;
Â  Â  Â  Â  Â  Â  Â  Â  drawToDoList(instanceId);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function deleteToDoItem(instanceId, id) {
Â  Â  Â  Â  Â  Â  todoLists[instanceId] = todoLists[instanceId].filter(i => i.id != id);
Â  Â  Â  Â  Â  Â  drawToDoList(instanceId);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderToDoList(contentEl, instanceId) {
Â  Â  Â  Â  Â  Â  // Initialize with a mock list if not already present
Â  Â  Â  Â  Â  Â  if (!todoLists[instanceId]) {
Â  Â  Â  Â  Â  Â  Â  Â  todoLists[instanceId] = [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 1, text: 'Finalize UI color palette', done: true },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 2, text: 'Implement window resizing logic (stretch goal)', done: false },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 3, text: 'Add placeholder icon for all apps', done: false },
Â  Â  Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  contentEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="h-full flex flex-col space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-xl font-bold text-cyan-400">Task Log (Instance: ${instanceId.split('-')[1]})</h4>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="new-todo-input" class="flex-grow bg-gray-800 text-white p-2 rounded border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Add a new task...">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="add-todo-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded transition duration-200 font-semibold">Add</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="todo-list-items" class="flex-grow overflow-y-auto pr-2" style="max-height: 100%;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  // Setup listeners
Â  Â  Â  Â  Â  Â  const addBtn = contentEl.querySelector('#add-todo-btn');
Â  Â  Â  Â  Â  Â  addBtn.addEventListener('click', () => addToDoItem(instanceId));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const inputEl = contentEl.querySelector('#new-todo-input');
Â  Â  Â  Â  Â  Â  inputEl.addEventListener('keypress', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addToDoItem(instanceId);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  contentEl.querySelector('#todo-list-items').addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  const id = e.target.dataset.id;
Â  Â  Â  Â  Â  Â  Â  Â  if (e.target.closest('.todo-delete-btn')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  deleteToDoItem(instanceId, id);
Â  Â  Â  Â  Â  Â  Â  Â  } else if (e.target.closest('.todo-text')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleToDoItem(instanceId, id);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Draw initial list
Â  Â  Â  Â  Â  Â  drawToDoList(instanceId);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 6. Simple Text Editor (NEW) ---
Â  Â  Â  Â  function renderTextEditor(contentEl) {
Â  Â  Â  Â  Â  Â  contentEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="h-full flex flex-col space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showMessage('Save functionality is mock only.')" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded text-sm">Save</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showMessage('Open functionality is mock only.')" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-1 px-3 rounded text-sm">Open</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea class="code-input flex-grow" rows="15" placeholder="Start typing your notes or code here..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 7. Placeholder App Renderer (General Use) ---
Â  Â  Â  Â  function renderPlaceholderApp(contentEl, appName) {
Â  Â  Â  Â  Â  Â  contentEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col items-center justify-center h-full text-center p-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-3xl text-gray-500 mb-4 font-mono">APP_NOT_FOUND</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-lg text-gray-400">The <strong>${appName || 'requested'}</strong> application is currently a placeholder.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500 mt-2">Core services are functional: Metrics, Pretty Printer, Music Player, Calculator, and To Do List are available.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Initialization ---

Â  Â  Â  Â  function initShell() {
Â  Â  Â  Â  Â  Â  createLauncherMenu();
Â  Â  Â  Â  Â  Â  updateTime(); // Initial time setup
Â  Â  Â  Â  Â  Â  setInterval(updateTime, 1000); // Start the clock
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Autolaunch a couple of apps
Â  Â  Â  Â  Â  Â  createWindow(APPS.find(app => app.id === 'metrics'));
Â  Â  Â  Â  Â  Â  createWindow(APPS.find(app => app.id === 'calculator'));
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Boot Sequence Simulation ---

Â  Â  Â  Â  const bootSteps = [
Â  Â  Â  Â  Â  Â  { time: 500, status: "[INFO] System clock synchronized..." },
Â  Â  Â  Â  Â  Â  { time: 800, status: "[INIT] Loading core libraries (JS/Tailwind)..." },
Â  Â  Â  Â  Â  Â  { time: 1200, status: "[CORE] Initializing Window Manager..." },
Â  Â  Â  Â  Â  Â  { time: 1500, status: "[CORE] Establishing Taskbar and Launcher UI..." },
Â  Â  Â  Â  Â  Â  { time: 1800, status: "[FS] Checking virtual file integrity..." },
Â  Â  Â  Â  Â  Â  { time: 2000, status: "[NET] Pinging API endpoint (127.0.0.1)... Response: 200 OK" },
Â  Â  Â  Â  Â  Â  { time: 2400, status: "[TASK] Auto-launching Dev Metrics Hub and Calculator..." },
Â  Â  Â  Â  Â  Â  { time: 2700, status: "[SUCCESS] Shell ready. Starting desktop environment..." }
Â  Â  Â  Â  ];

Â  Â  Â  Â  function runBootSequence() {
Â  Â  Â  Â  Â  Â  const loadingBar = document.getElementById('loading-bar');
Â  Â  Â  Â  Â  Â  const loadingStatus = document.getElementById('loading-status');
Â  Â  Â  Â  Â  Â  let stepIndex = 0;

Â  Â  Â  Â  Â  Â  const interval = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  if (stepIndex < bootSteps.length) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const step = bootSteps[stepIndex];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingStatus.textContent = step.status;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingBar.style.width = `${((stepIndex + 1) / bootSteps.length) * 90}%`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stepIndex++;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(interval);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingBar.style.width = '100%';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingScreen.style.opacity = '0';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingScreen.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  osShell.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initShell();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 500); // Wait for fade-out
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 200); // Wait after 100% complete
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 300); // Speed of each step
Â  Â  Â  Â  }

Â  Â  Â  Â  window.onload = runBootSequence;

Â  Â  </script>
</body>
</html>
