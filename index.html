<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>KVN.OS Shell - Enhanced</title>
Â  Â  Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <style>
Â  Â  Â  Â  /* Custom styles for the professional, dark dev theme */
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --primary-bg: #111827; /* Deep Black */
Â  Â  Â  Â  Â  Â  --accent-cyan: #06b6d4; /* Vibrant Cyan for highlights */
Â  Â  Â  Â  Â  Â  --accent-green: #4ade80; /* Neon Green for status */
Â  Â  Â  Â  Â  Â  --text-color: #e5e7eb; /* Off-White for readability */
Â  Â  Â  Â  Â  Â  --card-bg: #1e293b; /* Slate 800 for card background */
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  }

Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  height: 100vh;
Â  Â  Â  Â  Â  Â  width: 100vw;
Â  Â  Â  Â  Â  Â  overflow: hidden;Â 
Â  Â  Â  Â  Â  Â  background-color: var(--primary-bg);
Â  Â  Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* 1. KVN.OS WINDOW STYLES */
Â  Â  Â  Â  .os-window {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  background-color: var(--card-bg);
Â  Â  Â  Â  Â  Â  border: 1px solid #334155;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
Â  Â  Â  Â  Â  Â  border-radius: 0.5rem;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  min-width: 300px;
Â  Â  Â  Â  Â  Â  min-height: 200px;
Â  Â  Â  Â  Â  Â  transition: box-shadow 0.1s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .os-window.focused {
Â  Â  Â  Â  Â  Â  z-index: 50; /* Z-index managed in JS, but a base is needed */
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 0 2px var(--accent-cyan);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .window-title-bar {
Â  Â  Â  Â  Â  Â  cursor: grab;
Â  Â  Â  Â  Â  Â  background-color: #0f172a; /* Darker header */
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #334155;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .window-content {
Â  Â  Â  Â  Â  Â  padding: 1rem;
Â  Â  Â  Â  Â  Â  height: calc(100% - 40px); /* Adjust for title bar height */
Â  Â  Â  Â  Â  Â  overflow: auto;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* 2. METRICS HUB STYLES */
Â  Â  Â  Â  .metric-card {
Â  Â  Â  Â  Â  Â  background-color: #1a2333;Â 
Â  Â  Â  Â  Â  Â  border: 1px solid #334155;
Â  Â  Â  Â  Â  Â  box-shadow: none;Â 
Â  Â  Â  Â  Â  Â  transition: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .metric-value {
Â  Â  Â  Â  Â  Â  color: var(--accent-cyan);
Â  Â  Â  Â  Â  Â  font-family: 'Consolas', 'Monospace', monospace;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  }
Â  Â  Â  Â  .metric-label {
Â  Â  Â  Â  Â  Â  color: #94a3b8;
Â  Â  Â  Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  letter-spacing: 0.05em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .progress-bar {
Â  Â  Â  Â  Â  Â  height: 6px;
Â  Â  Â  Â  Â  Â  background-color: #475569;
Â  Â  Â  Â  Â  Â  border-radius: 9999px;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â  .progress-bar-fill {
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background-color: var(--accent-green);
Â  Â  Â  Â  Â  Â  transition: width 0.3s ease-out;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* 3. LOADING SCREEN STYLES */
Â  Â  Â  Â  .loading-bar-inner {
Â  Â  Â  Â  Â  Â  background-color: var(--accent-cyan);
Â  Â  Â  Â  Â  Â  transition: width 0.18s linear;
Â  Â  Â  Â  }
Â  Â  Â  Â  .loading-screen-text {
Â  Â  Â  Â  Â  Â  font-family: 'Consolas', 'Monospace', monospace;
Â  Â  Â  Â  Â  Â  color: #9ca3af;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* 4. TEXTAREA / CODE STYLES */
Â  Â  Â  Â  textarea.code-input, textarea.code-output {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 0.75rem;
Â  Â  Â  Â  Â  Â  border-radius: 0.375rem;
Â  Â  Â  Â  Â  Â  font-family: 'Consolas', 'Monospace', monospace;
Â  Â  Â  Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  Â  Â  Â  color: var(--accent-green);
Â  Â  Â  Â  Â  Â  background-color: #0f172a;
Â  Â  Â  Â  Â  Â  border: 1px solid #334155;
Â  Â  Â  Â  Â  Â  resize: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* 5. CALCULATOR STYLES */
Â  Â  Â  Â  .calc-display {
Â  Â  Â  Â  Â  Â  background-color: #000;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 1rem;
Â  Â  Â  Â  Â  Â  font-size: 2.5rem;
Â  Â  Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  Â  Â  border-radius: 0.25rem;
Â  Â  Â  Â  Â  Â  overflow-x: auto;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  Â  Â  margin-bottom: 0.5rem;
Â  Â  Â  Â  Â  Â  height: 70px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .calc-button {
Â  Â  Â  Â  Â  Â  background-color: #334155;
Â  Â  Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  Â  Â  padding: 1rem;
Â  Â  Â  Â  Â  Â  font-size: 1.25rem;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  border-radius: 0.5rem;
Â  Â  Â  Â  Â  Â  transition: background-color 0.15s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .calc-button:hover {
Â  Â  Â  Â  Â  Â  background-color: #475569;
Â  Â  Â  Â  }
Â  Â  Â  Â  .calc-op {
Â  Â  Â  Â  Â  Â  background-color: #06b6d4; /* Cyan */
Â  Â  Â  Â  }
Â  Â  Â  Â  .calc-op:hover {
Â  Â  Â  Â  Â  Â  background-color: #0891b2;
Â  Â  Â  Â  }
Â  Â  Â  Â  .calc-eq {
Â  Â  Â  Â  Â  Â  background-color: #4ade80; /* Green */
Â  Â  Â  Â  Â  Â  color: #0f172a;
Â  Â  Â  Â  }
Â  Â  Â  Â  .calc-eq:hover {
Â  Â  Â  Â  Â  Â  background-color: #22c55e;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* 6. TODO LIST STYLES */
Â  Â  Â  Â  .todo-item {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  padding: 0.5rem 0;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #334155;
Â  Â  Â  Â  }
Â  Â  Â  Â  .todo-text {
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: color 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .todo-done .todo-text {
Â  Â  Â  Â  Â  Â  text-decoration: line-through;
Â  Â  Â  Â  Â  Â  color: #64748b; /* Slate 500 */
Â  Â  Â  Â  }
Â  Â  Â  Â  .todo-delete-btn {
Â  Â  Â  Â  Â  Â  color: #ef4444; /* Red */
Â  Â  Â  Â  Â  Â  opacity: 0.7;
Â  Â  Â  Â  Â  Â  transition: opacity 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .todo-delete-btn:hover {
Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  }
Â  Â  </style>
</head>

<body oncontextmenu="return false;">

Â  Â  Â  Â  <div id="loading-screen" class="fixed inset-0 bg-gray-900 z-[200] flex flex-col items-center justify-center p-8 transition-opacity duration-500 ease-in-out opacity-100 overflow-hidden loading-screen-text">
Â  Â  Â  Â  <div class="text-3xl md:text-4xl font-mono font-semibold text-cyan-400 mb-12 text-center tracking-wider">
Â  Â  Â  Â  Â  Â  KVN.OS // INITIALIZING SHELL
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="w-full max-w-lg bg-gray-800 rounded h-1 border border-gray-700 overflow-hidden">
Â  Â  Â  Â  Â  Â  <div id="loading-bar" class="loading-bar-inner h-full" style="width: 0%;"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="loading-status" class="mt-8 text-sm font-mono p-2 text-gray-400">
Â  Â  Â  Â  Â  Â  [INIT] Initializing system services...
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="boot-log" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-700 text-xs font-mono opacity-20 whitespace-pre-wrap">
Â  Â  Â  Â  Â  Â  Loading kernel v5.18-dev...
Â  Â  Â  Â  Â  Â  Mounting root file system...
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  Â  Â  <div id="os-shell" class="flex flex-col flex-grow h-full w-full hidden">
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="window-container" class="flex-grow relative overflow-hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <footer id="taskbar" class="flex-shrink-0 w-full bg-gray-900 bg-opacity-90 backdrop-blur-sm p-2 shadow-2xl z-50 border-t border-gray-700">
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center max-w-7xl mx-auto">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dropdown relative">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="launcher-button" class="taskbar-item bg-gray-800 hover:bg-gray-700 text-white px-3 py-1 rounded transition duration-200 shadow-md font-semibold flex items-center space-x-2 border border-cyan-700/50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-cyan-400" viewBox="0 0 20 20" fill="currentColor">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Launcher</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="app-launcher-menu" class="hidden absolute bottom-full left-0 mb-2 w-64 bg-gray-800 rounded-lg shadow-xl p-2 border border-cyan-700 z-50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="running-apps" class="flex space-x-2 mx-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="time-display" class="taskbar-item bg-gray-800 text-sm text-gray-300 px-3 py-1 rounded font-mono"></span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </footer>
Â  Â  </div>


Â  Â  Â  Â  <div id="message-box" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-900 p-6 rounded-lg shadow-2xl z-[100] border-t-2 border-cyan-500 text-center">
Â  Â  Â  Â  <p id="message-text" class="text-white mb-4 font-mono"></p>
Â  Â  Â  Â  <button onclick="hideMessage()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white py-2 rounded font-semibold transition duration-200">Acknowledge</button>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // --- Globals ---
Â  Â  Â  Â  const osShell = document.getElementById('os-shell');
Â  Â  Â  Â  const loadingScreen = document.getElementById('loading-screen');
Â  Â  Â  Â  const windowContainer = document.getElementById('window-container');
Â  Â  Â  Â  const runningAppsContainer = document.getElementById('running-apps');
Â  Â  Â  Â  const appLauncherMenu = document.getElementById('app-launcher-menu');
Â  Â  Â  Â  const OS_START_TIME = Date.now();
Â  Â  Â  Â Â 
Â  Â  Â  Â  let lastFrameTime = performance.now();
Â  Â  Â  Â  let frameCount = 0;
Â  Â  Â  Â  let zIndexCounter = 10;
Â  Â  Â  Â  let isMetricsLoopRunning = false;
Â  Â  Â  Â  // Updated activeWindows to store minimized status
Â  Â  Â  Â  const activeWindows = {}; // { id: { element: windowElement, appId: 'metrics', isMinimized: false } }

        // --- MUSIC PLAYER STATE (NEW GLOBAL) ---
Â  Â  Â  Â  const musicPlayerState = {
Â  Â  Â  Â  Â  Â  isPlaying: false,
Â  Â  Â  Â  Â  Â  currentTime: 0,
Â  Â  Â  Â  Â  Â  duration: 180, // Mock 3:00 minutes
Â  Â  Â  Â  Â  Â  volume: 75,
Â  Â  Â  Â  Â  Â  trackName: "System_Theme_Loop_A.wav",
Â  Â  Â  Â  Â  Â  intervalId: null,
Â  Â  Â  Â  Â  Â  widgetEl: null, // Holds the micro-player widget element
Â  Â  Â  Â  Â  Â  mainInstanceId: null, // Stores the ID of the main Music Player window
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- APPS Definition (Reordered working apps to the top) ---
Â  Â  Â  Â  const APPS = [
Â  Â  Â  Â  Â  Â  { id: 'metrics', name: 'Dev Metrics Hub', icon: 'ðŸ“ˆ', content: 'metrics', width: 900, height: 600, x: 50, y: 50 },
Â  Â  Â  Â  Â  Â  { id: 'prettyprint', name: 'Java Pretty Printer', icon: 'ðŸ’»', content: 'prettyprinter', width: 600, height: 450, x: 100, y: 100 },
Â  Â  Â  Â  Â  Â  { id: 'music', name: 'Music Player', icon: 'ðŸŽµ', content: 'musicplayer', width: 450, height: 500, x: 150, y: 150 },
Â  Â  Â  Â  Â  Â  { id: 'calculator', name: 'Calculator', icon: 'ðŸ§®', content: 'calculator', width: 320, height: 480, x: 200, y: 200 },
Â  Â  Â  Â  Â  Â  { id: 'todo', name: 'To Do List', icon: 'âœ…', content: 'todolist', width: 400, height: 550, x: 250, y: 250 },
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Remaining Placeholder Apps
Â  Â  Â  Â  Â  Â  { id: 'textedit', name: 'Simple Text Editor', icon: 'ðŸ“', content: 'texteditor', width: 500, height: 350 },
Â  Â  Â  Â  Â  Â  { id: 'calendar', name: 'Calendar', icon: 'ðŸ“…', content: 'placeholder', width: 400, height: 300 },
Â  Â  Â  Â  Â  Â  { id: 'settings', name: 'System Settings', icon: 'âš™ï¸', content: 'placeholder', width: 450, height: 400 },
Â  Â  Â  Â  Â  Â  { id: 'filemgr', name: 'File Manager', icon: 'ðŸ“', content: 'placeholder', width: 700, height: 500 },
Â  Â  Â  Â  Â  Â  { id: 'browser', name: 'Web Browser', icon: 'ðŸŒ', content: 'placeholder', width: 800, height: 600 },
Â  Â  Â  Â  Â  Â  { id: 'chat', name: 'Chat Client', icon: 'ðŸ’¬', content: 'placeholder', width: 500, height: 600 },
Â  Â  Â  Â  Â  Â  { id: 'paint', name: 'Image Painter', icon: 'ðŸŽ¨', content: 'placeholder', width: 700, height: 600 },
Â  Â  Â  Â  Â  Â  { id: 'map', name: 'Map Viewer', icon: 'ðŸ—ºï¸', content: 'placeholder', width: 600, height: 400 },
Â  Â  Â  Â  Â  Â  { id: 'terminal', name: 'Legacy Terminal', icon: 'ðŸ“Ÿ', content: 'placeholder', width: 650, height: 450 },
Â  Â  Â  Â  Â  Â  { id: 'taskmgr', name: 'Task Manager', icon: 'ðŸ›‘', content: 'placeholder', width: 400, height: 550 },
Â  Â  Â  Â  Â  Â  { id: 'photo', name: 'Photo Viewer', icon: 'ðŸ–¼ï¸', content: 'placeholder', width: 500, height: 400 },
Â  Â  Â  Â  Â  Â  { id: 'debugger', name: 'Code Debugger', icon: 'ðŸž', content: 'placeholder', width: 700, height: 500 },
Â  Â  Â  Â  Â  Â  { id: 'network', name: 'Network Monitor', icon: 'ðŸ“¡', content: 'placeholder', width: 550, height: 400 },
Â  Â  Â  Â  Â  Â  { id: 'logs', name: 'System Logs', icon: 'ðŸ“œ', content: 'placeholder', width: 600, height: 400 },
Â  Â  Â  Â  Â  Â  { id: 'notes', name: 'Quick Notes', icon: 'ðŸ“Œ', content: 'placeholder', width: 350, height: 300 },
Â  Â  Â  Â  Â  Â  { id: 'games', name: 'Minesweeper', icon: 'ðŸ’£', content: 'placeholder', width: 350, height: 350 },
Â  Â  Â  Â  ];


Â  Â  Â  Â  // --- Utility Functions ---

Â  Â  Â  Â  function showMessage(message) {
Â  Â  Â  Â  Â  Â  document.getElementById('message-text').innerHTML = message;
Â  Â  Â  Â  Â  Â  document.getElementById('message-box').classList.remove('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  function hideMessage() {
Â  Â  Â  Â  Â  Â  document.getElementById('message-box').classList.add('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateTime() {
Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
Â  Â  Â  Â  Â  Â  const dateString = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: '2-digit' });
Â  Â  Â  Â  Â  Â  document.getElementById('time-display').textContent = `${dateString} | ${timeString}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Update app count metric (if metrics window is open)
Â  Â  Â  Â  Â  Â  if (activeWindows['metrics']) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('metric-time-utc').textContent = now.toUTCString().split(' ')[4];
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('metric-date-local').textContent = now.toLocaleDateString();
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('metric-timezone').textContent = now.toLocaleTimeString('en-us',{timeZoneName:'short'}).split(' ')[2];
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('metric-app-count').textContent = Object.values(activeWindows).filter(w => !w.isMinimized).length;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- OS SHELL: Window Management ---

Â  Â  Â  Â  function focusWindow(windowEl) {
Â  Â  Â  Â  Â  Â  // Check if the element exists and is not minimized
Â  Â  Â  Â  Â  Â  if (!windowEl || windowEl.classList.contains('minimized')) return;

Â  Â  Â  Â  Â  Â  // Unfocus all windows
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.os-window').forEach(win => {
Â  Â  Â  Â  Â  Â  Â  Â  win.classList.remove('focused');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Focus the clicked window
Â  Â  Â  Â  Â  Â  windowEl.classList.add('focused');
Â  Â  Â  Â  Â  Â  zIndexCounter++;
Â  Â  Â  Â  Â  Â  windowEl.style.zIndex = zIndexCounter;
Â  Â  Â  Â  }

Â  Â  Â  Â  // NEW: Minimize function - HOOKED FOR MUSIC PLAYER WIDGET
Â  Â  Â  Â  function minimizeWindow(instanceId) {
Â  Â  Â  Â  Â  Â  const windowData = activeWindows[instanceId];
Â  Â  Â  Â  Â  Â  if (!windowData) return;

Â  Â  Â  Â  Â  Â  windowData.element.classList.add('minimized');
Â  Â  Â  Â  Â  Â  windowData.element.style.display = 'none'; // Hide it
Â  Â  Â  Â  Â  Â  windowData.isMinimized = true;
Â  Â  Â  Â  Â  Â  updateRunningAppsList();
            
            // WIDGET HOOK: Show micro-player if music player is minimized
            if (musicPlayerState.mainInstanceId === instanceId) {
                showMicroPlayerWidget();
            }
Â  Â  Â  Â  }

Â  Â  Â  Â  // NEW: Restore function (called from taskbar) - HOOKED FOR MUSIC PLAYER WIDGET
Â  Â  Â  Â  function restoreWindow(instanceId) {
Â  Â  Â  Â  Â  Â  const windowData = activeWindows[instanceId];
Â  Â  Â  Â  Â  Â  if (!windowData) return;

Â  Â  Â  Â  Â  Â  windowData.element.classList.remove('minimized');
Â  Â  Â  Â  Â  Â  windowData.element.style.display = 'block'; // Show it
Â  Â  Â  Â  Â  Â  windowData.isMinimized = false;
Â  Â  Â  Â  Â  Â  focusWindow(windowData.element);
Â  Â  Â  Â  Â  Â  updateRunningAppsList();

            // WIDGET HOOK: Hide micro-player if music player is restored
            if (musicPlayerState.mainInstanceId === instanceId) {
                hideMicroPlayerWidget();
            }
Â  Â  Â  Â  }

Â  Â  Â  Â  // HOOKED FOR MUSIC PLAYER WIDGET
Â  Â  Â  Â  function closeWindow(instanceId) {
Â  Â  Â  Â  Â  Â  const windowData = activeWindows[instanceId];
Â  Â  Â  Â  Â  Â  if (!windowData) return;

Â  Â  Â  Â  Â  Â  // Stop music playback and hide widget if it's the music player
            if (musicPlayerState.mainInstanceId === instanceId) {
                stopPlayback();
                hideMicroPlayerWidget();
                musicPlayerState.mainInstanceId = null;
            }

Â  Â  Â  Â  Â  Â  // Remove window element
Â  Â  Â  Â  Â  Â  windowData.element.remove();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Stop metric loop if it was the metrics app being closed
Â  Â  Â  Â  Â  Â  if (windowData.appId === 'metrics' && Object.values(activeWindows).filter(w => w.appId === 'metrics').length === 1) {
Â  Â  Â  Â  Â  Â  Â  Â  isMetricsLoopRunning = false;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Remove from active windows
Â  Â  Â  Â  Â  Â  delete activeWindows[instanceId];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Update running apps list in taskbar
Â  Â  Â  Â  Â  Â  updateRunningAppsList();

Â  Â  Â  Â  Â  Â  // Find the highest z-index and focus it
Â  Â  Â  Â  Â  Â  const remainingWindows = Object.values(activeWindows).map(w => w.element);
Â  Â  Â  Â  Â  Â  if (remainingWindows.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  let maxZIndex = -1;
Â  Â  Â  Â  Â  Â  Â  Â  let topWindow = null;
Â  Â  Â  Â  Â  Â  Â  Â  remainingWindows.forEach(win => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!win.classList.contains('minimized')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const z = parseInt(win.style.zIndex || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (z > maxZIndex) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  maxZIndex = z;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  topWindow = win;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  if (topWindow) focusWindow(topWindow);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function createWindow(appInfo) {
Â  Â  Â  Â  Â  Â  // Generate a unique instance ID for this window
Â  Â  Â  Â  Â  Â  const instanceId = appInfo.id + '-' + Date.now();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- 1. Create Window Element ---
Â  Â  Â  Â  Â  Â  const windowEl = document.createElement('div');
Â  Â  Â  Â  Â  Â  windowEl.id = instanceId;
Â  Â  Â  Â  Â  Â  windowEl.className = 'os-window focused';
Â  Â  Â  Â  Â  Â  windowEl.style.width = `${appInfo.width}px`;
Â  Â  Â  Â  Â  Â  windowEl.style.height = `${appInfo.height}px`;
Â  Â  Â  Â  Â  Â  windowEl.style.left = `${appInfo.x || (Math.random() * 100 + 50)}px`;
Â  Â  Â  Â  Â  Â  windowEl.style.top = `${appInfo.y || (Math.random() * 100 + 50)}px`;

Â  Â  Â  Â  Â  Â  // --- 2. Title Bar and Controls ---
Â  Â  Â  Â  Â  Â  windowEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="window-title-bar p-2 flex justify-between items-center text-sm text-gray-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="flex items-center space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-lg leading-none">${appInfo.icon}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold">${appInfo.name}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="minimizeWindow('${instanceId}')" class="w-6 h-6 rounded-full bg-yellow-500 hover:bg-yellow-600 text-white flex items-center justify-center transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M20 12H4"></path></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="closeWindow('${instanceId}')" class="w-6 h-6 rounded-full bg-red-600 hover:bg-red-700 text-white flex items-center justify-center transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="window-content" id="content-${instanceId}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- 3. Dragging Logic ---
Â  Â  Â  Â  Â  Â  const titleBar = windowEl.querySelector('.window-title-bar');
Â  Â  Â  Â  Â  Â  titleBar.addEventListener('mousedown', (e) => startDrag(e, windowEl));
Â  Â  Â  Â  Â  Â  windowEl.addEventListener('mousedown', () => focusWindow(windowEl));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Add to the container and focus
Â  Â  Â  Â  Â  Â  windowContainer.appendChild(windowEl);
Â  Â  Â  Â  Â  Â  focusWindow(windowEl);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Register and render content
Â  Â  Â  Â  Â  Â  activeWindows[instanceId] = { element: windowEl, appId: appInfo.id, isMinimized: false };
Â  Â  Â  Â  Â  Â  renderAppContent(instanceId, appInfo.content);
Â  Â  Â  Â  Â  Â  updateRunningAppsList();
Â  Â  Â  Â  }

Â  Â  Â  Â  let dragState = { isDragging: false, activeWindow: null, offset: { x: 0, y: 0 } };

Â  Â  Â  Â  function startDrag(e, windowEl) {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  focusWindow(windowEl);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  dragState.isDragging = true;
Â  Â  Â  Â  Â  Â  dragState.activeWindow = windowEl;
Â  Â  Â  Â  Â  Â  dragState.offset.x = e.clientX - windowEl.offsetLeft;
Â  Â  Â  Â  Â  Â  dragState.offset.y = e.clientY - windowEl.offsetTop;

Â  Â  Â  Â  Â  Â  windowEl.style.cursor = 'grabbing';
Â  Â  Â  Â  Â  Â  windowEl.querySelector('.window-title-bar').style.cursor = 'grabbing';
Â  Â  Â  Â  }

Â  Â  Â  Â  function drag(e) {
Â  Â  Â  Â  Â  Â  if (!dragState.isDragging) return;
Â  Â  Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  Â  Â  const win = dragState.activeWindow;
Â  Â  Â  Â  Â  Â  const shellBounds = windowContainer.getBoundingClientRect();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let newLeft = e.clientX - dragState.offset.x;
Â  Â  Â  Â  Â  Â  let newTop = e.clientY - dragState.offset.y;

Â  Â  Â  Â  Â  Â  // Boundary checks
Â  Â  Â  Â  Â  Â  newLeft = Math.max(0, Math.min(newLeft, shellBounds.width - win.offsetWidth));
Â  Â  Â  Â  Â  Â  newTop = Math.max(0, Math.min(newTop, shellBounds.height - win.offsetHeight));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  win.style.left = `${newLeft}px`;
Â  Â  Â  Â  Â  Â  win.style.top = `${newTop}px`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function endDrag() {
Â  Â  Â  Â  Â  Â  if (dragState.isDragging) {
Â  Â  Â  Â  Â  Â  Â  Â  dragState.activeWindow.style.cursor = 'default';
Â  Â  Â  Â  Â  Â  Â  Â  dragState.activeWindow.querySelector('.window-title-bar').style.cursor = 'grab';
Â  Â  Â  Â  Â  Â  Â  Â  dragState.isDragging = false;
Â  Â  Â  Â  Â  Â  Â  Â  dragState.activeWindow = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  document.addEventListener('mousemove', drag);
Â  Â  Â  Â  document.addEventListener('mouseup', endDrag);

Â  Â  Â  Â  // --- OS SHELL: Taskbar/Launcher Management ---

Â  Â  Â  Â  function toggleLauncherMenu() {
Â  Â  Â  Â  Â  Â  appLauncherMenu.classList.toggle('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  document.getElementById('launcher-button').addEventListener('click', toggleLauncherMenu);
Â  Â  Â  Â  // Hide launcher when clicking outside
Â  Â  Â  Â  document.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  if (!document.getElementById('launcher-button').contains(e.target) && !appLauncherMenu.contains(e.target)) {
Â  Â  Â  Â  Â  Â  Â  Â  appLauncherMenu.classList.add('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  function createLauncherMenu() {
Â  Â  Â  Â  Â  Â  APPS.forEach(app => {
Â  Â  Â  Â  Â  Â  Â  Â  const button = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  button.className = 'w-full text-left p-2 rounded flex items-center space-x-3 hover:bg-gray-700 transition duration-150';
Â  Â  Â  Â  Â  Â  Â  Â  button.innerHTML = `<span class="text-xl">${app.icon}</span> <span>${app.name}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  button.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createWindow(app);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appLauncherMenu.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  appLauncherMenu.appendChild(button);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateRunningAppsList() {
Â  Â  Â  Â  Â  Â  runningAppsContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Group by app ID (in case multiple instances are open)
Â  Â  Â  Â  Â  Â  const runningAppInstances = Object.values(activeWindows);
Â  Â  Â  Â  Â  Â  const uniqueAppIds = [...new Set(runningAppInstances.map(w => w.appId))];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  uniqueAppIds.forEach(appId => {
Â  Â  Â  Â  Â  Â  Â  Â  const appInfo = APPS.find(app => app.id === appId);
Â  Â  Â  Â  Â  Â  Â  Â  const instances = runningAppInstances.filter(w => w.appId === appId);
Â  Â  Â  Â  Â  Â  Â  Â  const isMinimized = instances.every(w => w.isMinimized);

Â  Â  Â  Â  Â  Â  Â  Â  const button = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Color change if all instances are minimized
Â  Â  Â  Â  Â  Â  Â  Â  const baseClasses = 'taskbar-item px-3 py-1 rounded transition duration-200 shadow-md font-semibold text-sm flex items-center space-x-2';
Â  Â  Â  Â  Â  Â  Â  Â  button.className = isMinimizedÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? baseClasses + ' bg-gray-700 hover:bg-gray-600 text-gray-400 border border-gray-500'Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : baseClasses + ' bg-cyan-800 hover:bg-cyan-700 text-white border border-cyan-500';

Â  Â  Â  Â  Â  Â  Â  Â  button.innerHTML = `<span class="text-lg leading-none">${appInfo.icon}</span><span>${appInfo.name}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Clicking running app button restores/focuses
Â  Â  Â  Â  Â  Â  Â  Â  button.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const instancesKeys = Object.keys(activeWindows).filter(key => activeWindows[key].appId === appId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (instancesKeys.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const topInstanceKey = instancesKeys.reduce((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const zA = parseInt(activeWindows[a].element.style.zIndex || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const zB = parseInt(activeWindows[b].element.style.zIndex || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return zA > zB ? a : b;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const topWindowData = activeWindows[topInstanceKey];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (topWindowData.isMinimized) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  restoreWindow(topInstanceKey);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  focusWindow(topWindowData.element);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  runningAppsContainer.appendChild(button);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- APP CONTENT RENDERING ---

Â  Â  Â  Â  function renderAppContent(instanceId, contentType) {
Â  Â  Â  Â  Â  Â  const contentEl = document.getElementById(`content-${instanceId}`);
Â  Â  Â  Â  Â  Â  if (!contentEl) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Clear content and ensure padding is correct before rendering
Â  Â  Â  Â  Â  Â  contentEl.innerHTML = '';
Â  Â  Â  Â  Â  Â  contentEl.classList.add('p-4');Â 

Â  Â  Â  Â  Â  Â  switch (contentType) {
Â  Â  Â  Â  Â  Â  Â  Â  case 'metrics':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentEl.classList.remove('p-4'); // Metrics uses its own internal padding
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderMetricsApp(contentEl);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isMetricsLoopRunning) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startMetricsLoop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'prettyprinter':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderPrettyPrinter(contentEl);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'musicplayer':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderMusicPlayer(contentEl);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'calculator':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderCalculator(contentEl, instanceId); // Pass instanceId for state isolation
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'todolist':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderToDoList(contentEl, instanceId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'texteditor':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderTextEditor(contentEl);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'placeholder':
Â  Â  Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderPlaceholderApp(contentEl, APPS.find(a => a.id === activeWindows[instanceId].appId)?.name);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- WIDGET DRAG LOGIC (NEW) ---
Â  Â  Â  Â  let widgetDragState = { isDragging: false, offset: { x: 0, y: 0 }, widgetEl: null };

Â  Â  Â  Â  function startWidgetDrag(e, widgetEl) {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  // Only drag if the click is on the main widget body (not the button)
Â  Â  Â  Â  Â  Â  if (e.target.closest('#widget-play-btn') === null) {
Â  Â  Â  Â  Â  Â  Â  Â  widgetDragState.isDragging = true;
Â  Â  Â  Â  Â  Â  Â  Â  widgetDragState.widgetEl = widgetEl;
Â  Â  Â  Â  Â  Â  Â  Â  const rect = widgetEl.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  Â  Â  widgetDragState.offset.x = e.clientX - rect.left;
Â  Â  Â  Â  Â  Â  Â  Â  widgetDragState.offset.y = e.clientY - rect.top;

Â  Â  Â  Â  Â  Â  Â  Â  // Attach listeners to the document to allow dragging outside the widget
Â  Â  Â  Â  Â  Â  Â  Â  document.addEventListener('mousemove', dragWidget);
Â  Â  Â  Â  Â  Â  Â  Â  document.addEventListener('mouseup', endWidgetDrag);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function dragWidget(e) {
Â  Â  Â  Â  Â  Â  if (!widgetDragState.isDragging) return;
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const widgetEl = widgetDragState.widgetEl;
Â  Â  Â  Â  Â  Â  const offset = widgetDragState.offset;
Â  Â  Â  Â  Â  Â  const maxX = window.innerWidth - widgetEl.offsetWidth;
Â  Â  Â  Â  Â  Â  const maxY = window.innerHeight - widgetEl.offsetHeight - 50; // Above taskbar

Â  Â  Â  Â  Â  Â  // Calculate new position and clamp to viewport edges
Â  Â  Â  Â  Â  Â  let newX = Math.min(Math.max(0, e.clientX - offset.x), maxX);
Â  Â  Â  Â  Â  Â  let newY = Math.min(Math.max(0, e.clientY - offset.y), maxY);

Â  Â  Â  Â  Â  Â  // Apply new coordinates
Â  Â  Â  Â  Â  Â  widgetEl.style.position = 'fixed';
Â  Â  Â  Â  Â  Â  widgetEl.style.right = 'auto';
Â  Â  Â  Â  Â  Â  widgetEl.style.top = 'auto';

Â  Â  Â  Â  Â  Â  widgetEl.style.left = `${newX}px`;
Â  Â  Â  Â  Â  Â  widgetEl.style.top = `${newY}px`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function endWidgetDrag() {
Â  Â  Â  Â  Â  Â  if (widgetDragState.isDragging) {
Â  Â  Â  Â  Â  Â  Â  Â  widgetDragState.isDragging = false;
Â  Â  Â  Â  Â  Â  Â  Â  document.removeEventListener('mousemove', dragWidget);
Â  Â  Â  Â  Â  Â  Â  Â  document.removeEventListener('mouseup', endWidgetDrag);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- 1. Dev Metrics Hub (Metrics Content) ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  function getMetricEl(id) {
Â  Â  Â  Â  Â  Â  const windowData = Object.values(activeWindows).find(w => w.appId === 'metrics');
Â  Â  Â  Â  Â  Â  if (!windowData) return null;
Â  Â  Â  Â  Â  Â  return windowData.element.querySelector(`#${id}`);
Â  Â  Â  Â  }
Â  Â  Â  Â  // (Helper functions for metrics loop retained for brevity)
Â  Â  Â  Â  function formatUptime(ms) {
Â  Â  Â  Â  Â  Â  const totalSeconds = Math.floor(ms / 1000);
Â  Â  Â  Â  Â  Â  const days = Math.floor(totalSeconds / (3600 * 24));
Â  Â  Â  Â  Â  Â  const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
Â  Â  Â  Â  Â  Â  const minutes = Math.floor((totalSeconds % 3600) / 60);
Â  Â  Â  Â  Â  Â  const seconds = totalSeconds % 60;
Â  Â  Â  Â  Â  Â  return `${days.toString().padStart(2, '0')}d ${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateMetrics() {
Â  Â  Â  Â  Â  Â  if (!isMetricsLoopRunning) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const now = performance.now();
Â  Â  Â  Â  Â  Â  const frameTime = now - lastFrameTime;
Â  Â  Â  Â  Â  Â  lastFrameTime = now;
Â  Â  Â  Â  Â  Â  frameCount++;

Â  Â  Â  Â  Â  Â  // 1. Performance Metrics
Â  Â  Â  Â  Â  Â  const fps = Math.round(1000 / frameTime);
Â  Â  Â  Â  Â  Â  const uptime = formatUptime(Date.now() - OS_START_TIME);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let memoryInfo = {};
Â  Â  Â  Â  Â  Â  if (window.performance && window.performance.memory) {
Â  Â  Â  Â  Â  Â  Â  Â  memoryInfo = window.performance.memory;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const heapUsed = (memoryInfo.usedJSHeapSize / 1048576 || 0).toFixed(2);
Â  Â  Â  Â  Â  Â  const heapTotal = (memoryInfo.totalJSHeapSize / 1048576 || 0).toFixed(2);
Â  Â  Â  Â  Â  Â  const heapLimit = (memoryInfo.jsHeapSizeLimit / 1048576 || 0).toFixed(0);

Â  Â  Â  Â  Â  Â  const dnsMock = (Math.random() * 50 + 5).toFixed(1);
Â  Â  Â  Â  Â  Â  const loadTimeMock = (now + Math.random() * 500).toFixed(0); // Mocking initial load time

Â  Â  Â  Â  Â  Â  const fpsEl = getMetricEl('metric-fps');
Â  Â  Â  Â  Â  Â  if (fpsEl) fpsEl.textContent = Math.min(fps, 60);

Â  Â  Â  Â  Â  Â  const usedEl = getMetricEl('metric-heap-used');
Â  Â  Â  Â  Â  Â  if (usedEl) usedEl.textContent = heapUsed;

Â  Â  Â  Â  Â  Â  const totalEl = getMetricEl('metric-heap-total');
Â  Â  Â  Â  Â  Â  if (totalEl) totalEl.textContent = heapTotal;

Â  Â  Â  Â  Â  Â  const limitEl = getMetricEl('metric-memory-limit');
Â  Â  Â  Â  Â  Â  if (limitEl) limitEl.textContent = `${heapLimit} MB`;

Â  Â  Â  Â  Â  Â  const uptimeEl = getMetricEl('metric-uptime');
Â  Â  Â  Â  Â  Â  if (uptimeEl) uptimeEl.textContent = uptime;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const dnsEl = getMetricEl('metric-dns-lookup');
Â  Â  Â  Â  Â  Â  if (dnsEl) dnsEl.textContent = `${dnsMock} ms`;

Â  Â  Â  Â  Â  Â  const loadEl = getMetricEl('metric-load-time');
Â  Â  Â  Â  Â  Â  if (loadEl) loadEl.textContent = `${loadTimeMock} ms`;

Â  Â  Â  Â  Â  Â  const paintEl = getMetricEl('metric-time-paint');
Â  Â  Â  Â  Â  Â  if (paintEl) paintEl.textContent = (performance.getEntriesByName('first-paint')[0]?.startTime || 0).toFixed(2);

Â  Â  Â  Â  Â  Â  const originEl = getMetricEl('metric-time-origin');
Â  Â  Â  Â  Â  Â  if (originEl) originEl.textContent = OS_START_TIME.toFixed(0);


Â  Â  Â  Â  Â  Â  // 2. Resource Allocation
Â  Â  Â  Â  Â  Â  const openWindows = Object.values(activeWindows).length;
Â  Â  Â  Â  Â  Â  const totalApps = APPS.length;
Â  Â  Â  Â  Â  Â  const windowUsage = Math.min((openWindows / 5) * 100, 100).toFixed(0);

Â  Â  Â  Â  Â  Â  const windowCountEl = getMetricEl('metric-open-windows');
Â  Â  Â  Â  Â  Â  if (windowCountEl) windowCountEl.textContent = openWindows;

Â  Â  Â  Â  Â  Â  const windowTotalEl = getMetricEl('metric-total-apps');
Â  Â  Â  Â  Â  Â  if (windowTotalEl) windowTotalEl.textContent = totalApps;

Â  Â  Â  Â  Â  Â  const windowUsageFill = getMetricEl('metric-window-usage-fill');
Â  Â  Â  Â  Â  Â  if (windowUsageFill) windowUsageFill.style.width = `${windowUsage}%`;


Â  Â  Â  Â  Â  Â  // 3. Client Metadata (Static or less frequent updates)
Â  Â  Â  Â  Â  Â  // These are populated on render, so just a placeholder update if needed
Â  Â  Â  Â  Â  Â  const batteryLevel = navigator.getBattery ? (await navigator.getBattery()).level : (Math.random() * 0.3 + 0.6).toFixed(2);
Â  Â  Â  Â  Â  Â  const batteryEl = getMetricEl('metric-battery-level');
Â  Â  Â  Â  Â  Â  if (batteryEl) batteryEl.textContent = `${(batteryLevel * 100).toFixed(0)}%`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const batteryFill = getMetricEl('metric-battery-fill');
Â  Â  Â  Â  Â  Â  if (batteryFill) {
Â  Â  Â  Â  Â  Â  Â  Â  batteryFill.style.width = `${(batteryLevel * 100).toFixed(0)}%`;
Â  Â  Â  Â  Â  Â  Â  Â  batteryFill.style.backgroundColor = batteryLevel < 0.2 ? '#ef4444' : '#4ade80';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 4. Task/System Mock
Â  Â  Â  Â  Â  Â  const taskProgress = ((Date.now() / 1000) % 100).toFixed(0); // Mock value
Â  Â  Â  Â  Â  Â  const taskProgressEl = getMetricEl('metric-task-progress-fill');
Â  Â  Â  Â  Â  Â  if (taskProgressEl) taskProgressEl.style.width = `${taskProgress}%`;

Â  Â  Â  Â  Â  Â  requestAnimationFrame(updateMetrics);
Â  Â  Â  Â  }

Â  Â  Â  Â  function startMetricsLoop() {
Â  Â  Â  Â  Â  Â  isMetricsLoopRunning = true;
Â  Â  Â  Â  Â  Â  // Initial population of static metrics
Â  Â  Â  Â  Â  Â  const userAgent = navigator.userAgent;
Â  Â  Â  Â  Â  Â  let browserName = 'Unknown';
Â  Â  Â  Â  Â  Â  let browserVersion = 'N/A';
Â  Â  Â  Â  Â  Â  if (userAgent.includes('Chrome')) {
Â  Â  Â  Â  Â  Â  Â  Â  browserName = 'Chrome';
Â  Â  Â  Â  Â  Â  Â  Â  browserVersion = userAgent.match(/Chrome\/([\d.]+)/)?.[1] || browserVersion;
Â  Â  Â  Â  Â  Â  } else if (userAgent.includes('Firefox')) {
Â  Â  Â  Â  Â  Â  Â  Â  browserName = 'Firefox';
Â  Â  Â  Â  Â  Â  Â  Â  browserVersion = userAgent.match(/Firefox\/([\d.]+)/)?.[1] || browserVersion;
Â  Â  Â  Â  Â  Â  } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
Â  Â  Â  Â  Â  Â  Â  Â  browserName = 'Safari';
Â  Â  Â  Â  Â  Â  Â  Â  browserVersion = userAgent.match(/Version\/([\d.]+)/)?.[1] || browserVersion;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let osName = 'Unknown';
Â  Â  Â  Â  Â  Â  let osVersion = 'N/A';
Â  Â  Â  Â  Â  Â  const platform = navigator.platform;
Â  Â  Â  Â  Â  Â  if (platform.includes('Win')) {
Â  Â  Â  Â  Â  Â  Â  Â  osName = 'Windows';
Â  Â  Â  Â  Â  Â  Â  Â  osVersion = userAgent.includes('NT 10.0') ? '10/11' : 'Older';
Â  Â  Â  Â  Â  Â  } else if (platform.includes('Mac')) {
Â  Â  Â  Â  Â  Â  Â  Â  osName = 'macOS';
Â  Â  Â  Â  Â  Â  Â  Â  osVersion = userAgent.includes('Mac OS X') ? userAgent.split('Mac OS X ')[1].split(')')[0].replace(/_/g, '.') : 'Older';
Â  Â  Â  Â  Â  Â  } else if (platform.includes('Linux')) {
Â  Â  Â  Â  Â  Â  Â  Â  osName = 'Linux';
Â  Â  Â  Â  Â  Â  Â  Â  osVersion = 'Kernel';
Â  Â  Â  Â  Â  Â  } else if (userAgent.includes('Android')) {
Â  Â  Â  Â  Â  Â  Â  Â  osName = 'Android';
Â  Â  Â  Â  Â  Â  } else if (userAgent.includes('iPhone') || userAgent.includes('iPad')) {
Â  Â  Â  Â  Â  Â  Â  Â  osName = 'iOS/iPadOS';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const browserEl = getMetricEl('metric-browser-name');
Â  Â  Â  Â  Â  Â  if (browserEl) browserEl.textContent = browserName;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const versionEl = getMetricEl('metric-browser-version');
Â  Â  Â  Â  Â  Â  if (versionEl) versionEl.textContent = browserVersion;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const osNameEl = getMetricEl('metric-os-name');
Â  Â  Â  Â  Â  Â  if (osNameEl) osNameEl.textContent = osName;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const osVersionEl = getMetricEl('metric-os-version');
Â  Â  Â  Â  Â  Â  if (osVersionEl) osVersionEl.textContent = osVersion;

Â  Â  Â  Â  Â  Â  requestAnimationFrame(updateMetrics);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderMetricsApp(contentEl) {
Â  Â  Â  Â  Â  Â  // ... (Metrics HTML template is extensive but omitted here for focus on new apps)
Â  Â  Â  Â  Â  Â  contentEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <main class="h-full w-full overflow-y-auto p-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="lg:col-span-2 col-span-1 metric-card p-4 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-lg font-semibold mb-3 text-accent-green">PERFORMANCE TELEMETRY (9 Metrics)</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-b border-gray-700 pb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value text-2xl" id="metric-fps">60</span><span class="text-gray-400 ml-1">FPS</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Frame Rate</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-b border-gray-700 pb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value text-2xl" id="metric-heap-used">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Used JS Heap (MB)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-b border-gray-700 pb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value text-xl" id="metric-heap-total">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Total JS Heap (MB)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-b border-gray-700 pb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value text-xl" id="metric-time-origin">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Time Origin (ms)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-b border-gray-700 pb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value text-xl" id="metric-time-paint">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">First Paint (ms)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-b border-gray-700 pb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value text-xl" id="metric-load-time">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Load Time (ms, Mock)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-span-2 border-b border-gray-700 pb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value text-xl" id="metric-uptime">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Time Since Init (App Uptime)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-span-2 border-b border-gray-700 pb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value text-xl" id="metric-dns-lookup">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">DNS Lookup Time (ms, Mock)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-span-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value text-xl" id="metric-memory-limit">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Memory Limit (Approx)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-span-1 metric-card p-4 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-lg font-semibold mb-3 text-accent-cyan">CLIENT METADATA (8 Metrics)</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-b border-gray-700 pb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Browser / Version</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value" id="metric-browser-name">--</span> / <span class="metric-value" id="metric-browser-version">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-b border-gray-700 pb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">OS Name / Version</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value" id="metric-os-name">--</span> / <span class="metric-value" id="metric-os-version">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-b border-gray-700 pb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Local Date / UTC Time</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value" id="metric-date-local">--</span> / <span class="metric-value" id="metric-time-utc">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-b border-gray-700 pb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Timezone</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value" id="metric-timezone">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-b border-gray-700 pb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Screen Resolution</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value" id="metric-resolution">${window.innerWidth}x${window.innerHeight}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-b border-gray-700 pb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">App Windows Open</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value text-2xl" id="metric-app-count">0</span> / ${APPS.length}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-b border-gray-700 pb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Connectivity</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value" id="metric-connection-type">${navigator.connection?.effectiveType || 'wifi'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="pb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Max Threads (Concurrency)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value" id="metric-threads">${navigator.hardwareConcurrency || 4}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-span-1 lg:col-span-2 metric-card p-4 rounded-lg flex flex-col justify-between">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-lg font-semibold mb-3 text-yellow-400">RESOURCE ALLOCATION & STATUS</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label mb-1">Window Resource Usage (Estimated)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-bar">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="metric-window-usage-fill" class="progress-bar-fill bg-orange-500" style="width: 0%;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label mb-1 flex justify-between">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Battery Level</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="metric-value" id="metric-battery-level">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-bar">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="metric-battery-fill" class="progress-bar-fill" style="width: 0%; background-color: #4ade80;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label mb-1">System Integrity Check (Running)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-bar">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="metric-task-progress-fill" class="progress-bar-fill bg-cyan-500" style="width: 50%;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </main>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 2. Simple Text Editor (Text Editor Content) ---
Â  Â  Â  Â  function renderTextEditor(contentEl) {
Â  Â  Â  Â  Â  Â  contentEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col h-full w-full space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showMessage('Save action triggered. (Mock)')" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded text-sm transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Save File
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showMessage('Open action triggered. (Mock)')" class="bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-1 px-3 rounded text-sm transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Open File
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="text-editor-input" class="code-input flex-grow h-full" placeholder="// Type your notes or code here...\n\nfunction setup() {\nÂ  console.log('Text Editor Initialized');\n}" style="height: calc(100% - 40px);"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 3. Java Pretty Printer (Pretty Printer Content) ---
Â  Â  Â  Â  function renderPrettyPrinter(contentEl) {
Â  Â  Â  Â  Â  Â  const instanceId = contentEl.parentElement.id;
Â  Â  Â  Â  Â  Â  contentEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col h-full space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="java-input-${instanceId}" class="code-input h-48" placeholder="Paste unformatted Java code here..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="pretty-print-btn-${instanceId}" class="bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-2 px-4 rounded transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Run Prettifier
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="java-output-${instanceId}" class="code-output flex-grow" readonly placeholder="Formatted code output will appear here..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById(`pretty-print-btn-${instanceId}`).onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const input = document.getElementById(`java-input-${instanceId}`).value;
Â  Â  Â  Â  Â  Â  Â  Â  const outputEl = document.getElementById(`java-output-${instanceId}`);
Â  Â  Â  Â  Â  Â  Â  Â  if (input.trim() === '') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  outputEl.value = 'Error: No code provided to format.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // Mock formatting: simply adds indentation and a header
Â  Â  Â  Â  Â  Â  Â  Â  const lines = input.split('\n').map(line => line.trim());
Â  Â  Â  Â  Â  Â  Â  Â  let formatted = '/* KVN.OS Prettifier v1.1 */\n';
Â  Â  Â  Â  Â  Â  Â  Â  let indentLevel = 0;
Â  Â  Â  Â  Â  Â  Â  Â  lines.forEach(line => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (line.endsWith('}')) indentLevel = Math.max(0, indentLevel - 1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const indent = 'Â  '.repeat(indentLevel);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (line) formatted += indent + line + '\n';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (line.endsWith('{')) indentLevel++;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  outputEl.value = formatted;
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('Code formatted successfully. (Mock)');
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 4. Music Player (Music Player Content) ---

Â  Â  Â  Â  // --- MUSIC PLAYER WIDGET LOGIC (NEW) ---

Â  Â  Â  Â  function createMicroPlayerWidget() {
Â  Â  Â  Â  Â  Â  if (musicPlayerState.widgetEl) return; // Widget already exists

Â  Â  Â  Â  Â  Â  const widget = document.createElement('div');
Â  Â  Â  Â  Â  Â  widget.id = 'micro-player-widget';
Â  Â  Â  Â  Â  Â  // Small size, high z-index, drag handle, fixed position
Â  Â  Â  Â  Â  Â  widget.className = 'fixed top-1/4 right-4 w-56 h-16 bg-gray-900 border border-cyan-500 rounded-lg shadow-2xl p-2 cursor-pointer z-[100] transition-opacity duration-300 opacity-0 hidden';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Widget Content: Track, Play/Pause, Volume, Waveform
Â  Â  Â  Â  Â  Â  widget.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center h-full" onmousedown="startWidgetDrag(event, this.parentElement)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="widget-play-btn" onclick="togglePlayPause('widget')" class="flex-shrink-0 w-8 h-8 rounded-full bg-cyan-600 hover:bg-cyan-700 text-white flex items-center justify-center transition duration-150 mr-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg id="widget-play-icon" class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4V16L17 10L7 4Z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow min-w-0 mr-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs font-mono truncate text-cyan-400" id="widget-track-name">--</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="relative h-3 w-full mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="absolute inset-0 flex items-end space-x-0.5" id="widget-waveform">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${Array(10).fill().map((_, i) => `<div class="bg-green-500 rounded-full" style="width: 2px; height: ${Math.floor(Math.random() * 8 + 3)}px; opacity: ${0.5 + Math.random() * 0.5};"></div>`).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-shrink-0 text-sm font-semibold text-gray-300 w-6 text-right" id="widget-volume">${musicPlayerState.volume}%</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  document.body.appendChild(widget);
Â  Â  Â  Â  Â  Â  musicPlayerState.widgetEl = widget;
Â  Â  Â  Â  Â  Â  updateWidgetDisplay();
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateWidgetDisplay() {
Â  Â  Â  Â  Â  Â  if (!musicPlayerState.widgetEl) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Update Play/Pause Icon
Â  Â  Â  Â  Â  Â  const playIcon = document.getElementById('widget-play-icon');
Â  Â  Â  Â  Â  Â  if (playIcon) {
Â  Â  Â  Â  Â  Â  Â  Â  playIcon.innerHTML = musicPlayerState.isPlaying
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? '<path d="M6 5H8V15H6zM12 5H14V15H12z"/>' // Pause
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : '<path d="M7 4V16L17 10L7 4Z"/>'; Â  Â  Â // Play
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Update Track Name and Volume
Â  Â  Â  Â  Â  Â  const trackNameEl = document.getElementById('widget-track-name');
Â  Â  Â  Â  Â  Â  if (trackNameEl) trackNameEl.textContent = musicPlayerState.trackName;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const volumeEl = document.getElementById('widget-volume');
Â  Â  Â  Â  Â  Â  if (volumeEl) volumeEl.textContent = `${musicPlayerState.volume}%`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Mock waveform animation: change heights slightly every second
Â  Â  Â  Â  Â  Â  const waveformEl = document.getElementById('widget-waveform');
Â  Â  Â  Â  Â  Â  if (waveformEl && musicPlayerState.isPlaying) {
Â  Â  Â  Â  Â  Â  Â  Â  Array.from(waveformEl.children).forEach(bar => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bar.style.height = `${Math.floor(Math.random() * 8 + 3)}px`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } else if (waveformEl) {
Â  Â  Â  Â  Â  Â  Â  Â  // Reset to static when paused
Â  Â  Â  Â  Â  Â  Â  Â  Array.from(waveformEl.children).forEach(bar => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bar.style.height = '3px';
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function showMicroPlayerWidget() {
Â  Â  Â  Â  Â  Â  if (!musicPlayerState.widgetEl) {
Â  Â  Â  Â  Â  Â  Â  Â  createMicroPlayerWidget();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Make sure it's the active window ID before showing
Â  Â  Â  Â  Â  Â  if (musicPlayerState.mainInstanceId && activeWindows[musicPlayerState.mainInstanceId].isMinimized) {
Â  Â  Â  Â  Â  Â  Â  Â  musicPlayerState.widgetEl.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => musicPlayerState.widgetEl.classList.remove('opacity-0'), 10);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function hideMicroPlayerWidget() {
Â  Â  Â  Â  Â  Â  if (musicPlayerState.widgetEl) {
Â  Â  Â  Â  Â  Â  Â  Â  musicPlayerState.widgetEl.classList.add('opacity-0');
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => musicPlayerState.widgetEl.classList.add('hidden'), 300);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  // --- MUSIC PLAYER CORE FUNCTIONS ---

Â  Â  Â  Â  function updateMusicDisplay() {
Â  Â  Â  Â  Â  Â  const state = musicPlayerState;
Â  Â  Â  Â  Â  Â  const mainEl = document.getElementById(`content-${state.mainInstanceId}`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (mainEl) {
Â  Â  Â  Â  Â  Â  Â  Â  const minutes = Math.floor(state.currentTime / 60).toString().padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â  Â  const seconds = Math.floor(state.currentTime % 60).toString().padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Main Window Updates
Â  Â  Â  Â  Â  Â  Â  Â  mainEl.querySelector('#track-name').textContent = state.trackName;
Â  Â  Â  Â  Â  Â  Â  Â  mainEl.querySelector('#current-time').textContent = `${minutes}:${seconds}`;
Â  Â  Â  Â  Â  Â  Â  Â  mainEl.querySelector('#play-pause-icon').innerHTML = state.isPlaying
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `<svg class="h-8 w-8" fill="currentColor" viewBox="0 0 20 20"><path d="M6 5H8V15H6zM12 5H14V15H12z"/></svg>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : `<svg class="h-8 w-8" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4V16L17 10L7 4Z"/></svg>`;

Â  Â  Â  Â  Â  Â  Â  Â  const progress = (state.currentTime / state.duration) * 100;
Â  Â  Â  Â  Â  Â  Â  Â  mainEl.querySelector('#progress-bar-fill-music').style.width = `${progress}%`;
Â  Â  Â  Â  Â  Â  Â  Â  mainEl.querySelector('#volume-range').value = state.volume;
Â  Â  Â  Â  Â  Â  Â  Â  mainEl.querySelector('#volume-text').textContent = state.volume;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Update Widget Display
Â  Â  Â  Â  Â  Â  if (state.widgetEl && !state.widgetEl.classList.contains('hidden')) {
Â  Â  Â  Â  Â  Â  Â  Â  updateWidgetDisplay();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function togglePlayPause(source) {
Â  Â  Â  Â  Â  Â  const state = musicPlayerState;
Â  Â  Â  Â  Â  Â  if (state.isPlaying) {
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(state.intervalId);
Â  Â  Â  Â  Â  Â  Â  Â  state.isPlaying = false;
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('Playback Paused: System_Theme_Loop_A.wav');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  state.isPlaying = true;
Â  Â  Â  Â  Â  Â  Â  Â  state.intervalId = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.currentTime++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (state.currentTime > state.duration) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.currentTime = 0; // Loop mock
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateMusicDisplay();
Â  Â  Â  Â  Â  Â  Â  Â  }, 1000);
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('Playback Started: System_Theme_Loop_A.wav');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateMusicDisplay();
Â  Â  Â  Â  }

Â  Â  Â  Â  function stopPlayback() {
Â  Â  Â  Â  Â  Â  clearInterval(musicPlayerState.intervalId);
Â  Â  Â  Â  Â  Â  musicPlayerState.isPlaying = false;
Â  Â  Â  Â  Â  Â  musicPlayerState.currentTime = 0;
Â  Â  Â  Â  Â  Â  updateMusicDisplay();
Â  Â  Â  Â  }

Â  Â  Â  Â  function setVolume(volume) {
Â  Â  Â  Â  Â  Â  musicPlayerState.volume = volume;
Â  Â  Â  Â  Â  Â  updateMusicDisplay();
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderMusicPlayer(contentEl) {
Â  Â  Â  Â  Â  Â  const instanceId = contentEl.parentElement.id;
Â  Â  Â  Â  Â  Â  musicPlayerState.mainInstanceId = instanceId; // Register this instance as the main one

Â  Â  Â  Â  Â  Â  const totalMinutes = Math.floor(musicPlayerState.duration / 60).toString().padStart(2, '0');
Â  Â  Â  Â  Â  Â  const totalSeconds = Math.floor(musicPlayerState.duration % 60).toString().padStart(2, '0');

Â  Â  Â  Â  Â  Â  contentEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col h-full w-full space-y-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-center h-32 w-32 mx-auto bg-gray-800 rounded-lg border border-cyan-800 p-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="h-20 w-20 text-cyan-400" fill="currentColor" viewBox="0 0 20 20"><path d="M18 3a2 2 0 00-2-2H4a2 2 0 00-2 2v14a2 2 0 002 2h12a2 2 0 002-2V3zM9 5h2v6H9V5zm0 8h2v2H9v-2zM6 5h2v6H6V5zm0 8h2v2H6v-2zm8 0h-2v-2h2v2zm0-8h-2v6h2V5z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="track-name" class="text-xl font-bold text-white">${musicPlayerState.trackName}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-gray-400 text-sm">KVN.OS System Artist</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-bar">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="progress-bar-fill-music" class="progress-bar-fill" style="width: 0%;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between text-xs text-gray-500 font-mono">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="current-time">00:00</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${totalMinutes}:${totalSeconds}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-center space-x-6 pt-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showMessage('Previous track (Mock)')" class="text-gray-400 hover:text-cyan-400 transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20"><path d="M12.793 4.793a1 1 0 010 1.414L9.414 10l3.379 3.379a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="togglePlayPause('main')" class="text-white bg-cyan-600 hover:bg-cyan-700 w-12 h-12 rounded-full flex items-center justify-center transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="play-pause-icon">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="h-8 w-8" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4V16L17 10L7 4Z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showMessage('Next track (Mock)')" class="text-gray-400 hover:text-cyan-400 transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20"><path d="M7.207 15.207a1 1 0 010-1.414L10.586 10 7.207 6.621a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-3 pt-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="h-5 w-5 text-cyan-400" fill="currentColor" viewBox="0 0 20 20"><path d="M10 20a1 1 0 01-.707-.293l-5-5H2a1 1 0 01-1-1V6a1 1 0 011-1h2.293l5-5A1 1 0 0111 2v16a1 1 0 01-.707.952l-.045.048zM14 8a1 1 0 010 2 3 3 0 010 6 1 1 0 110-2 1 1 0 000-2 1 1 0 010-2zm3-3a1 1 0 010 2 6 6 0 010 10 1 1 0 110-2 4 4 0 000-8 1 1 0 010-2z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="range" id="volume-range" min="0" max="100" value="${musicPlayerState.volume}" oninput="setVolume(this.value)" class="flex-grow h-1 appearance-none bg-gray-600 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="volume-text" class="text-sm font-mono w-8 text-right">${musicPlayerState.volume}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  updateMusicDisplay();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 5. Calculator (Calculator Content) ---
Â  Â  Â  Â  const calcStates = {}; // Object to hold state for multiple calculator instances

Â  Â  Â  Â  function initializeCalculatorState(instanceId) {
Â  Â  Â  Â  Â  Â  calcStates[instanceId] = {
Â  Â  Â  Â  Â  Â  Â  Â  currentInput: '0',
Â  Â  Â  Â  Â  Â  Â  Â  operator: null,
Â  Â  Â  Â  Â  Â  Â  Â  previousValue: null,
Â  Â  Â  Â  Â  Â  Â  Â  waitingForSecondOperand: false,
Â  Â  Â  Â  Â  Â  Â  Â  decimalAdded: false
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateCalculatorDisplay(instanceId) {
Â  Â  Â  Â  Â  Â  const state = calcStates[instanceId];
Â  Â  Â  Â  Â  Â  const displayEl = document.getElementById(`calc-display-${instanceId}`);
Â  Â  Â  Â  Â  Â  if (displayEl) {
Â  Â  Â  Â  Â  Â  Â  Â  displayEl.textContent = state.currentInput;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleCalculatorInput(instanceId, type, value) {
Â  Â  Â  Â  Â  Â  const state = calcStates[instanceId];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (type === 'number') {
Â  Â  Â  Â  Â  Â  Â  Â  if (state.waitingForSecondOperand) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.currentInput = value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.waitingForSecondOperand = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.decimalAdded = false;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.currentInput = state.currentInput === '0' ? value : state.currentInput + value;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (type === 'decimal') {
Â  Â  Â  Â  Â  Â  Â  Â  if (!state.decimalAdded) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (state.waitingForSecondOperand) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.currentInput = '0.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.waitingForSecondOperand = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.currentInput += '.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.decimalAdded = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (type === 'operator') {
Â  Â  Â  Â  Â  Â  Â  Â  const inputValue = parseFloat(state.currentInput);

Â  Â  Â  Â  Â  Â  Â  Â  if (state.previousValue === null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.previousValue = inputValue;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (state.operator) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = calculate(state.previousValue, inputValue, state.operator);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.currentInput = String(result).substring(0, 10); // Limit digits
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.previousValue = result;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  state.waitingForSecondOperand = true;
Â  Â  Â  Â  Â  Â  Â  Â  state.operator = value;
Â  Â  Â  Â  Â  Â  Â  Â  state.decimalAdded = false;

Â  Â  Â  Â  Â  Â  } else if (type === 'equals') {
Â  Â  Â  Â  Â  Â  Â  Â  const inputValue = parseFloat(state.currentInput);
Â  Â  Â  Â  Â  Â  Â  Â  if (state.previousValue === null || state.operator === null) return;

Â  Â  Â  Â  Â  Â  Â  Â  const result = calculate(state.previousValue, inputValue, state.operator);
Â  Â  Â  Â  Â  Â  Â  Â  state.currentInput = String(result).substring(0, 10);
Â  Â  Â  Â  Â  Â  Â  Â  state.previousValue = null;
Â  Â  Â  Â  Â  Â  Â  Â  state.operator = null;
Â  Â  Â  Â  Â  Â  Â  Â  state.waitingForSecondOperand = true;
Â  Â  Â  Â  Â  Â  Â  Â  state.decimalAdded = state.currentInput.includes('.');

Â  Â  Â  Â  Â  Â  } else if (type === 'clear') {
Â  Â  Â  Â  Â  Â  Â  Â  initializeCalculatorState(instanceId);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  updateCalculatorDisplay(instanceId);
Â  Â  Â  Â  }

Â  Â  Â  Â  function calculate(first, second, operator) {
Â  Â  Â  Â  Â  Â  switch (operator) {
Â  Â  Â  Â  Â  Â  Â  Â  case '+': return first + second;
Â  Â  Â  Â  Â  Â  Â  Â  case '-': return first - second;
Â  Â  Â  Â  Â  Â  Â  Â  case '*': return first * second;
Â  Â  Â  Â  Â  Â  Â  Â  case '/': return second === 0 ? 'Error' : first / second;
Â  Â  Â  Â  Â  Â  Â  Â  default: return second;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderCalculator(contentEl, instanceId) {
Â  Â  Â  Â  Â  Â  initializeCalculatorState(instanceId);

Â  Â  Â  Â  Â  Â  const buttons = [
Â  Â  Â  Â  Â  Â  Â  Â  { label: 'AC', type: 'clear', class: 'col-span-2 bg-red-600 hover:bg-red-700' },
Â  Â  Â  Â  Â  Â  Â  Â  { label: 'Â±', type: 'sign', class: 'calc-button' },
Â  Â  Â  Â  Â  Â  Â  Â  { label: '/', type: 'operator', value: '/', class: 'calc-op' },
Â  Â  Â  Â  Â  Â  Â  Â  { label: '7', type: 'number', value: '7' },
Â  Â  Â  Â  Â  Â  Â  Â  { label: '8', type: 'number', value: '8' },
Â  Â  Â  Â  Â  Â  Â  Â  { label: '9', type: 'number', value: '9' },
Â  Â  Â  Â  Â  Â  Â  Â  { label: '*', type: 'operator', value: '*', class: 'calc-op' },
Â  Â  Â  Â  Â  Â  Â  Â  { label: '4', type: 'number', value: '4' },
Â  Â  Â  Â  Â  Â  Â  Â  { label: '5', type: 'number', value: '5' },
Â  Â  Â  Â  Â  Â  Â  Â  { label: '6', type: 'number', value: '6' },
Â  Â  Â  Â  Â  Â  Â  Â  { label: '-', type: 'operator', value: '-', class: 'calc-op' },
Â  Â  Â  Â  Â  Â  Â  Â  { label: '1', type: 'number', value: '1' },
Â  Â  Â  Â  Â  Â  Â  Â  { label: '2', type: 'number', value: '2' },
Â  Â  Â  Â  Â  Â  Â  Â  { label: '3', type: 'number', value: '3' },
Â  Â  Â  Â  Â  Â  Â  Â  { label: '+', type: 'operator', value: '+', class: 'calc-op' },
Â  Â  Â  Â  Â  Â  Â  Â  { label: '0', type: 'number', value: '0', class: 'col-span-2' },
Â  Â  Â  Â  Â  Â  Â  Â  { label: '.', type: 'decimal', value: '.', class: 'calc-button' },
Â  Â  Â  Â  Â  Â  Â  Â  { label: '=', type: 'equals', class: 'calc-eq' }
Â  Â  Â  Â  Â  Â  ];

Â  Â  Â  Â  Â  Â  const buttonHtml = buttons.map(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  const defaultClass = btn.type === 'number' || btn.type === 'decimal' ? 'calc-button' : '';
Â  Â  Â  Â  Â  Â  Â  Â  return `<button onclick="handleCalculatorInput('${instanceId}', '${btn.type}', '${btn.value || btn.label}')" class="${defaultClass} ${btn.class || ''}">${btn.label}</button>`;
Â  Â  Â  Â  Â  Â  }).join('');

Â  Â  Â  Â  Â  Â  contentEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col h-full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="calc-display-${instanceId}" class="calc-display text-4xl">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-4 gap-2 flex-grow">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${buttonHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  // Initial display update
Â  Â  Â  Â  Â  Â  updateCalculatorDisplay(instanceId);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 6. To Do List (To Do List Content) ---
Â  Â  Â  Â  const todoLists = {};

Â  Â  Â  Â  function getTodoListState(instanceId) {
Â  Â  Â  Â  Â  Â  if (!todoLists[instanceId]) {
Â  Â  Â  Â  Â  Â  Â  Â  todoLists[instanceId] = [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 1, text: 'Finalize UI refactor to Tailwind CSS', done: false },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 2, text: 'Implement window dragging logic', done: true },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 3, text: 'Add Micro Player Widget to Music App', done: false },
Â  Â  Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return todoLists[instanceId];
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateTodoListDOM(instanceId) {
Â  Â  Â  Â  Â  Â  const listEl = document.getElementById(`todo-list-${instanceId}`);
Â  Â  Â  Â  Â  Â  const tasks = getTodoListState(instanceId);
Â  Â  Â  Â  Â  Â  if (!listEl) return;

Â  Â  Â  Â  Â  Â  listEl.innerHTML = '';
Â  Â  Â  Â  Â  Â  tasks.forEach(task => {
Â  Â  Â  Â  Â  Â  Â  Â  const itemDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  itemDiv.className = `todo-item ${task.done ? 'todo-done' : ''}`;
Â  Â  Â  Â  Â  Â  Â  Â  itemDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" ${task.done ? 'checked' : ''} onchange="toggleTodoDone('${instanceId}', ${task.id})" class="h-4 w-4 text-cyan-600 bg-gray-700 border-gray-600 rounded cursor-pointer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="todo-text">${task.text}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="deleteTodo('${instanceId}', ${task.id})" class="todo-delete-btn text-lg leading-none">&times;</button>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  listEl.appendChild(itemDiv);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function addTodo(instanceId) {
Â  Â  Â  Â  Â  Â  const inputEl = document.getElementById(`todo-input-${instanceId}`);
Â  Â  Â  Â  Â  Â  const text = inputEl.value.trim();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (text) {
Â  Â  Â  Â  Â  Â  Â  Â  const tasks = getTodoListState(instanceId);
Â  Â  Â  Â  Â  Â  Â  Â  const newId = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
Â  Â  Â  Â  Â  Â  Â  Â  tasks.push({ id: newId, text: text, done: false });
Â  Â  Â  Â  Â  Â  Â  Â  inputEl.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  updateTodoListDOM(instanceId);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function toggleTodoDone(instanceId, id) {
Â  Â  Â  Â  Â  Â  const tasks = getTodoListState(instanceId);
Â  Â  Â  Â  Â  Â  const task = tasks.find(t => t.id === id);
Â  Â  Â  Â  Â  Â  if (task) {
Â  Â  Â  Â  Â  Â  Â  Â  task.done = !task.done;
Â  Â  Â  Â  Â  Â  Â  Â  updateTodoListDOM(instanceId);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function deleteTodo(instanceId, id) {
Â  Â  Â  Â  Â  Â  todoLists[instanceId] = getTodoListState(instanceId).filter(t => t.id !== id);
Â  Â  Â  Â  Â  Â  updateTodoListDOM(instanceId);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderToDoList(contentEl, instanceId) {
Â  Â  Â  Â  Â  Â  contentEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col h-full space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-2 flex-shrink-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="todo-input-${instanceId}" placeholder="New Task..." class="code-input flex-grow text-white" onkeydown="if(event.key === 'Enter') addTodo('${instanceId}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="addTodo('${instanceId}')" class="bg-accent-green hover:bg-green-600 text-gray-900 font-semibold py-2 px-4 rounded-lg transition duration-150 flex-shrink-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Add
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="todo-list-${instanceId}" class="flex-grow overflow-y-auto pt-2 space-y-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  updateTodoListDOM(instanceId);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 7. Placeholder App (Default Content) ---
Â  Â  Â  Â  function renderPlaceholderApp(contentEl, appName = 'Application') {
Â  Â  Â  Â  Â  Â  contentEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center p-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-bold text-cyan-400 mb-2">${appName}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-400 font-mono">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  [STATUS] System Module is currently offline.<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Future development required to enable full functionality.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- OS INITIALIZATION ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  function startOS() {
Â  Â  Â  Â  Â  Â  let progress = 0;
Â  Â  Â  Â  Â  Â  const loadingBar = document.getElementById('loading-bar');
Â  Â  Â  Â  Â  Â  const statusText = document.getElementById('loading-status');
Â  Â  Â  Â  Â  Â  const bootLog = document.getElementById('boot-log');

Â  Â  Â  Â  Â  Â  const messages = [
Â  Â  Â  Â  Â  Â  Â  Â  "[CORE] Loading system libraries...",
Â  Â  Â  Â  Â  Â  Â  Â  "[FS] Checking filesystem integrity...",
Â  Â  Â  Â  Â  Â  Â  Â  "[UI] Initializing window manager...",
Â  Â  Â  Â  Â  Â  Â  Â  "[NET] Connecting to local network...",
Â  Â  Â  Â  Â  Â  Â  Â  "[APPS] Registering application modules...",
Â  Â  Â  Â  Â  Â  Â  Â  "[FINISH] Boot sequence complete. Launching shell.",
Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let messageIndex = 0;

Â  Â  Â  Â  Â  Â  function updateBoot() {
Â  Â  Â  Â  Â  Â  Â  Â  if (progress < 100) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  progress += (100 - progress) / 15; // Accelerating progress
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingBar.style.width = `${progress}%`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const targetMessageIndex = Math.floor(progress / 20);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (targetMessageIndex > messageIndex) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  messageIndex = targetMessageIndex;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (messages[messageIndex]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusText.textContent = messages[messageIndex];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bootLog.textContent += `\n${messages[messageIndex]}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(updateBoot, 100);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingScreen.classList.add('opacity-0');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingScreen.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  osShell.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Auto-open a useful app on startup
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createWindow(APPS.find(app => app.id === 'metrics'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 500); // Wait for fade out
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Start Clock and Launcher Setup
Â  Â  Â  Â  Â  Â  setInterval(updateTime, 1000);
Â  Â  Â  Â  Â  Â  updateTime();
Â  Â  Â  Â  Â  Â  createLauncherMenu();

Â  Â  Â  Â  Â  Â  // Begin Boot Sequence
Â  Â  Â  Â  Â  Â  setTimeout(updateBoot, 500);
Â  Â  Â  Â  }

Â  Â  Â  Â  startOS();

Â  Â  </script>
</body>
</html>
